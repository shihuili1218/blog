<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ActiveMQ解析-客户端（消息发送端） | 并发笔记 - ofcoder.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><!-- 顶部加载进度条 --><script type="text/javascript" src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ActiveMQ解析-客户端（消息发送端）</h1><a id="logo" href="/.">并发笔记 - ofcoder.com</a><p class="description">一位后端开发的养肝历程，护发经验</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/usql/"><i class="fa fa-database"> usql</i></a><a href="/book/"><i class="fa fas fa-book"> book</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ActiveMQ解析-客户端（消息发送端）</h1><div class="post-meta">Jul 21, 2018<span> | </span><span class="category"><a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 10</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2018/07/21/middleware/activemq-producter/#vcomment"><span class="valine-comment-count" data-xid="/2018/07/21/middleware/activemq-producter/"></span><span> 条评论</span></a><div class="post-content"><p>&nbsp;&nbsp;&nbsp;&nbsp;本篇主要粗略介绍程序在启动时，连接mq做了哪些操作，你可能需要先自己阅读一遍源码，再来看本篇文章，或对照源码看本篇文章</p>
<h3 id="1-抛开spring，创建一个简单生产者"><a href="#1-抛开spring，创建一个简单生产者" class="headerlink" title="1 抛开spring，创建一个简单生产者"></a>1 抛开spring，创建一个简单生产者</h3><h4 id="1-1-安装windows版activemq"><a href="#1-1-安装windows版activemq" class="headerlink" title="1.1 安装windows版activemq"></a>1.1 安装windows版activemq</h4><ol>
<li>下载地址：<a href="http://activemq.apache.org/download.html" target="_blank" rel="noopener">http://activemq.apache.org/download.html</a></li>
<li>解压，启动bin\win64\activemq.bat</li>
<li>访问：<a href="http://localhost:8161/" target="_blank" rel="noopener">http://localhost:8161/</a></li>
</ol>
<h4 id="1-2-生产者"><a href="#1-2-生产者" class="headerlink" title="1.2 生产者"></a>1.2 生产者</h4><ol>
<li><p><strong>pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.15.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Producter</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producter</span> &#123;</span></span><br><span class="line">    <span class="comment">//ActiveMq 的默认用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> USERNAME = ActiveMQConnection.DEFAULT_USER;</span><br><span class="line">    <span class="comment">//ActiveMq 的默认登录密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> PASSWORD = ActiveMQConnection.DEFAULT_PASSWORD;</span><br><span class="line">    <span class="comment">//ActiveMQ 的链接地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> BROKEN_URL = ActiveMQConnection.DEFAULT_BROKER_URL;</span><br><span class="line">    <span class="comment">//链接工厂</span></span><br><span class="line">    ConnectionFactory connectionFactory;</span><br><span class="line">    <span class="comment">//链接对象</span></span><br><span class="line">    Connection connection;</span><br><span class="line">    <span class="comment">//事务管理</span></span><br><span class="line">    Session session;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建一个链接工厂</span></span><br><span class="line">            connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(USERNAME, PASSWORD, BROKEN_URL);</span><br><span class="line">            <span class="comment">//从工厂中创建一个链接</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">//开启链接</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">//创建一个事务（这里通过参数可以设置事务的级别）</span></span><br><span class="line">            session = connection.createSession(<span class="literal">true</span>, Session.SESSION_TRANSACTED);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">String</span> disname, <span class="keyword">String</span> content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建一个消息队列</span></span><br><span class="line">            Queue <span class="built_in">queue</span> = session.createQueue(disname);</span><br><span class="line">            <span class="comment">//消息生产者</span></span><br><span class="line">            MessageProducer messageProducer = session.createProducer(<span class="built_in">queue</span>);</span><br><span class="line">            <span class="comment">//创建一条消息</span></span><br><span class="line">            TextMessage msg = session.createTextMessage(content);</span><br><span class="line">            System.out.<span class="built_in">println</span>(content);</span><br><span class="line">            <span class="comment">//发送消息</span></span><br><span class="line">            messageProducer.send(msg);</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            session.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">			session.rollback();</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>测试</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span> </span>&#123;</span><br><span class="line">    Producter producter = <span class="keyword">new</span> Producter();</span><br><span class="line">    producter.init();</span><br><span class="line">    producter.sendMessage(<span class="string">"test"</span>, <span class="string">"interest"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="2-分析init-方法"><a href="#2-分析init-方法" class="headerlink" title="2 分析init()方法"></a>2 分析init()方法</h3><h4 id="2-1-connectionFactory-new-ActiveMQConnectionFactory-USERNAME-PASSWORD-BROKEN-URL"><a href="#2-1-connectionFactory-new-ActiveMQConnectionFactory-USERNAME-PASSWORD-BROKEN-URL" class="headerlink" title="2.1 connectionFactory = new ActiveMQConnectionFactory(USERNAME, PASSWORD, BROKEN_URL);"></a>2.1 connectionFactory = new ActiveMQConnectionFactory(USERNAME, PASSWORD, BROKEN_URL);</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;该语句只是将USERNAME, PASSWORD, BROKEN_URL设置到ActiveMQConnectionFactory的变量里面。</p>
<h4 id="2-2-connection-connectionFactory-createConnection"><a href="#2-2-connection-connectionFactory-createConnection" class="headerlink" title="2.2 connection = connectionFactory.createConnection();"></a>2.2 connection = connectionFactory.createConnection();</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;createConnection()方法只是单纯调用createActiveMQConnection()方法，createActiveMQConnection的源码如下</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">protected ActiveMQConnection create<span class="constructor">ActiveMQConnection(String <span class="params">userName</span>, String <span class="params">password</span>)</span> throws JMSException &#123;</span><br><span class="line">    <span class="keyword">if</span> (brokerURL<span class="operator"> == </span>null) &#123;</span><br><span class="line">        throw <span class="keyword">new</span> <span class="constructor">ConfigurationException(<span class="string">"brokerURL not set."</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ActiveMQConnection connection = null;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 2.2.1 创建Transport</span></span><br><span class="line">        Transport transport = create<span class="constructor">Transport()</span>;</span><br><span class="line">        <span class="comment">// 2.2.2 由transport和状态管理器创建连接</span></span><br><span class="line">        connection = create<span class="constructor">ActiveMQConnection(<span class="params">transport</span>, <span class="params">factoryStats</span>)</span>;</span><br><span class="line"></span><br><span class="line">        connection.set<span class="constructor">UserName(<span class="params">userName</span>)</span>;</span><br><span class="line">        connection.set<span class="constructor">Password(<span class="params">password</span>)</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 看名字就知道配置connection的参数，它也的确只做了这样事，把new ActiveMQConnectionFactory()时处理好的参数set到connection中</span></span><br><span class="line">        configure<span class="constructor">Connection(<span class="params">connection</span>)</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//一切准备就绪，就可以启动了</span></span><br><span class="line">        transport.start<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientID != null) &#123;</span><br><span class="line">            connection.set<span class="constructor">DefaultClientID(<span class="params">clientID</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        return connection;</span><br><span class="line">    &#125; catch (JMSException e) &#123;</span><br><span class="line">        <span class="comment">// Clean up!</span></span><br><span class="line">		connection.close<span class="literal">()</span>;</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        <span class="comment">// Clean up!</span></span><br><span class="line">        connection.close<span class="literal">()</span>;</span><br><span class="line">        throw <span class="module-access"><span class="module"><span class="identifier">JMSExceptionSupport</span>.</span></span>create(<span class="string">"Could not connect to broker URL: "</span> + brokerURL + <span class="string">". Reason: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-1-创建Transport，createTransport"><a href="#2-2-1-创建Transport，createTransport" class="headerlink" title="2.2.1 创建Transport，createTransport()"></a>2.2.1 创建Transport，createTransport()</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>粗略介绍：</strong>createTransport()，该方法首先从brokerURL中，取出scheme，scheme就是写在brokerUrl中的tcp、auto等关键字，然后根据scheme在一个保存了TransportFactory的ConcurrentMap中查找TransportFactory，没有就新new一个TransportFactory保存到ConcurrentMap中。然后调用TransportFactory.doConnect()，根据brokerUrl中的参数返回一个Transport的对象。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">protected Transport create<span class="constructor">Transport()</span> throws JMSException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        URI connectBrokerUL = brokerURL;</span><br><span class="line">        <span class="comment">//取出scheme</span></span><br><span class="line">        String scheme = brokerURL.get<span class="constructor">Scheme()</span>;</span><br><span class="line">        <span class="keyword">if</span> (scheme<span class="operator"> == </span>null) &#123;</span><br><span class="line">            throw <span class="keyword">new</span> <span class="constructor">IOException(<span class="string">"Transport not scheme specified: ["</span> + <span class="params">brokerURL</span> + <span class="string">"]"</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (scheme.equals(<span class="string">"auto"</span>)) &#123;</span><br><span class="line">            connectBrokerUL = <span class="keyword">new</span> <span class="constructor">URI(<span class="params">brokerURL</span>.<span class="params">toString</span>()</span>.replace(<span class="string">"auto"</span>, <span class="string">"tcp"</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scheme.equals(<span class="string">"auto+ssl"</span>)) &#123;</span><br><span class="line">            connectBrokerUL = <span class="keyword">new</span> <span class="constructor">URI(<span class="params">brokerURL</span>.<span class="params">toString</span>()</span>.replace(<span class="string">"auto+ssl"</span>, <span class="string">"ssl"</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scheme.equals(<span class="string">"auto+nio"</span>)) &#123;</span><br><span class="line">            connectBrokerUL = <span class="keyword">new</span> <span class="constructor">URI(<span class="params">brokerURL</span>.<span class="params">toString</span>()</span>.replace(<span class="string">"auto+nio"</span>, <span class="string">"nio"</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scheme.equals(<span class="string">"auto+nio+ssl"</span>)) &#123;</span><br><span class="line">            connectBrokerUL = <span class="keyword">new</span> <span class="constructor">URI(<span class="params">brokerURL</span>.<span class="params">toString</span>()</span>.replace(<span class="string">"auto+nio+ssl"</span>, <span class="string">"nio+ssl"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.2.1.1 根据scheme在Map中取出TransportFactory，获得Transport对象</span></span><br><span class="line">        return <span class="module-access"><span class="module"><span class="identifier">TransportFactory</span>.</span></span>connect(connectBrokerUL);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw <span class="module-access"><span class="module"><span class="identifier">JMSExceptionSupport</span>.</span></span>create(<span class="string">"Could not create Transport. Reason: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.2.1.1 根据scheme在Map中取出TransportFactory，获得Transport对象</strong></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">Transport <span class="title">connect</span><span class="params">(URI location)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//2.2.1.1.1 从ConcurrentMap中获取TransportFactory</span></span><br><span class="line">    TransportFactory tf = findTransportFactory(location);</span><br><span class="line">    <span class="comment">//2.2.1.1.2 从TransportFactory返回Transport对象</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> tf.<span class="title">doConnect</span><span class="params">(location)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.2.1.1.1 从ConcurrentMap中获取TransportFactory</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public static TransportFactory find<span class="constructor">TransportFactory(URI <span class="params">location</span>)</span> throws IOException &#123;</span><br><span class="line">    String scheme = location.get<span class="constructor">Scheme()</span>;</span><br><span class="line">    <span class="keyword">if</span> (scheme<span class="operator"> == </span>null) &#123;</span><br><span class="line">        throw <span class="keyword">new</span> <span class="constructor">IOException(<span class="string">"Transport not scheme specified: ["</span> + <span class="params">location</span> + <span class="string">"]"</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TRANSPORT_FACTORYS 保存着 TransportFactory的ConcurrentMap</span></span><br><span class="line">    TransportFactory tf = <span class="module-access"><span class="module"><span class="identifier">TRANSPORT_FACTORYS</span>.</span></span>get(scheme);</span><br><span class="line">    <span class="comment">//没有，则返回一个新对象并保存在map中</span></span><br><span class="line">    <span class="keyword">if</span> (tf<span class="operator"> == </span>null) &#123;</span><br><span class="line">        <span class="comment">// Try to load if from a META-INF property.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tf = (TransportFactory)<span class="module-access"><span class="module"><span class="identifier">TRANSPORT_FACTORY_FINDER</span>.</span></span><span class="keyword">new</span><span class="constructor">Instance(<span class="params">scheme</span>)</span>;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">TRANSPORT_FACTORYS</span>.</span></span>put(scheme, tf);</span><br><span class="line">        &#125; catch (Throwable e) &#123;</span><br><span class="line">            throw <span class="module-access"><span class="module"><span class="identifier">IOExceptionSupport</span>.</span></span>create(<span class="string">"Transport scheme NOT recognized: ["</span> + scheme + <span class="string">"]"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return tf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.2.1.1.2 从TransportFactory返回Transport对象</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public Transport <span class="keyword">do</span><span class="constructor">Connect(URI <span class="params">location</span>)</span> throws Exception &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; options = <span class="keyword">new</span> HashMap&lt;String, String&gt;(<span class="module-access"><span class="module"><span class="identifier">URISupport</span>.</span></span>parse<span class="constructor">Parameters(<span class="params">location</span>)</span>);</span><br><span class="line">        <span class="keyword">if</span>( !options.contains<span class="constructor">Key(<span class="string">"wireFormat.host"</span>)</span> ) &#123;</span><br><span class="line">            options.put(<span class="string">"wireFormat.host"</span>, location.get<span class="constructor">Host()</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        WireFormat wf = create<span class="constructor">WireFormat(<span class="params">options</span>)</span>;</span><br><span class="line">        <span class="comment">//2.2.1.1.2.1 创建Transport对象</span></span><br><span class="line">        Transport transport = create<span class="constructor">Transport(<span class="params">location</span>, <span class="params">wf</span>)</span>;</span><br><span class="line">        Transport rc = configure(transport, wf, options);</span><br><span class="line">        <span class="comment">//remove auto</span></span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">IntrospectionSupport</span>.</span></span>extract<span class="constructor">Properties(<span class="params">options</span>, <span class="string">"auto."</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!options.is<span class="constructor">Empty()</span>) &#123;</span><br><span class="line">            throw <span class="keyword">new</span> <span class="constructor">IllegalArgumentException(<span class="string">"Invalid connect parameters: "</span> + <span class="params">options</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        return rc;</span><br><span class="line">    &#125; catch (URISyntaxException e) &#123;</span><br><span class="line">        throw <span class="module-access"><span class="module"><span class="identifier">IOExceptionSupport</span>.</span></span>create(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.2.1.1.2.1 创建Transport对象</strong></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//由子类实现</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function">Transport <span class="title">createTransport</span><span class="params">(URI location, WireFormat wf)</span> <span class="keyword">throws</span> MalformedURLException, UnknownHostException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"createTransport() method not implemented!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.2.1.1.2.2 createTransport()由子类实现，TcpTransportFactory</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Transport create<span class="constructor">Transport(URI <span class="params">location</span>, WireFormat <span class="params">wf</span>)</span> throws UnknownHostException, IOException &#123;</span><br><span class="line">    URI localLocation = null;</span><br><span class="line">    String path = location.get<span class="constructor">Path()</span>;</span><br><span class="line">    <span class="comment">// see if the path is a local URI location</span></span><br><span class="line">    <span class="keyword">if</span> (path != null<span class="operator"> &amp;&amp; </span>path.length<span class="literal">()</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">int</span> localPortIndex = path.index<span class="constructor">Of(':')</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">Integer</span>.</span></span>parse<span class="constructor">Int(<span class="params">path</span>.<span class="params">substring</span>(<span class="params">localPortIndex</span> + 1, <span class="params">path</span>.<span class="params">length</span>()</span>));</span><br><span class="line">            String localString = location.get<span class="constructor">Scheme()</span> + <span class="string">":/"</span> + path;</span><br><span class="line">            localLocation = <span class="keyword">new</span> <span class="constructor">URI(<span class="params">localString</span>)</span>;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">LOG</span>.</span></span>warn(<span class="string">"path isn't a valid local location for TcpTransport to use"</span>, e.get<span class="constructor">Message()</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="module-access"><span class="module"><span class="identifier">LOG</span>.</span></span>is<span class="constructor">DebugEnabled()</span>) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">LOG</span>.</span></span>debug(<span class="string">"Failure detail"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//以上算是都在校验url</span></span><br><span class="line">    <span class="comment">//这一句new DefaultSocketFactory()对象返回</span></span><br><span class="line">    SocketFactory socketFactory = create<span class="constructor">SocketFactory()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// new一个TcpTransport对象，将wf，socketFactory放入该对象的变量里面</span></span><br><span class="line">    return create<span class="constructor">TcpTransport(<span class="params">wf</span>, <span class="params">socketFactory</span>, <span class="params">location</span>, <span class="params">localLocation</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-2-由transport和状态管理器创建连接"><a href="#2-2-2-由transport和状态管理器创建连接" class="headerlink" title="2.2.2 由transport和状态管理器创建连接"></a>2.2.2 由transport和状态管理器创建连接</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>粗略介绍：</strong>createActiveMQConnection()字面意思就是创建一个activeMQ的连接。这个连接是根据transport，和一个连接状态管理器JMSStats创建的，源码如下。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected ActiveMQConnection create<span class="constructor">ActiveMQConnection(Transport <span class="params">transport</span>, JMSStatsImpl <span class="params">stats</span>)</span> throws Exception &#123;</span><br><span class="line">    <span class="comment">//getConnectionIdGenerator(), getClientIdGenerator()这是一个同步方法，返回IdGenerator对象</span></span><br><span class="line">    <span class="comment">//transport 上面代码生成的Transport对象</span></span><br><span class="line">    <span class="comment">//stats 是一个JMSStatsImpl对象，有提供set方法，修改连接状态</span></span><br><span class="line">	<span class="comment">//2.2.2.2 ActiveMQConnection的构造</span></span><br><span class="line">    ActiveMQConnection connection = <span class="keyword">new</span> <span class="constructor">ActiveMQConnection(<span class="params">transport</span>, <span class="params">getClientIdGenerator</span>()</span>,</span><br><span class="line">            get<span class="constructor">ConnectionIdGenerator()</span>, stats);</span><br><span class="line">    return connection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>*<em>2.2.2.1 JMSStatsImpl *</em></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSStatsImpl</span> <span class="title">extends</span> <span class="title">StatsImpl</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">private</span> List connections;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JMSStatsImpl</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       <span class="comment">//CopyOnWriteArrayList，一开是所有线程共享内容，当你需要修改时将内容复制出来再修改，然后把旧的地址指向新地址，这样可以达到并发的读，而不需要加锁</span></span><br><span class="line">        connections = <span class="keyword">new</span> CopyOnWriteArrayList();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> JMSConnectionStatsImpl[] getConnections()</span><br><span class="line">    &#123;</span><br><span class="line">        Object connectionArray[] = connections.toArray();</span><br><span class="line">        <span class="keyword">int</span> <span class="built_in">size</span> = connectionArray.length;</span><br><span class="line">        JMSConnectionStatsImpl answer[] = <span class="keyword">new</span> JMSConnectionStatsImpl[<span class="built_in">size</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">size</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            ActiveMQConnection connection = (ActiveMQConnection)connectionArray[i];</span><br><span class="line">            answer[i] = connection.getConnectionStats();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> answer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addConnection</span><span class="params">(ActiveMQConnection connection)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        connections.add(connection);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeConnection</span><span class="params">(ActiveMQConnection connection)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        connections.<span class="built_in">remove</span>(connection);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dump</span><span class="params">(IndentPrinter out)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        out.printIndent();</span><br><span class="line">        out.<span class="built_in">println</span>(<span class="string">"factory &#123;"</span>);</span><br><span class="line">        out.incrementIndent();</span><br><span class="line">        JMSConnectionStatsImpl <span class="built_in">array</span>[] = getConnections();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">array</span>.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            JMSConnectionStatsImpl connectionStat = <span class="built_in">array</span>[i];</span><br><span class="line">            connectionStat.dump(out);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out.decrementIndent();</span><br><span class="line">        out.printIndent();</span><br><span class="line">        out.<span class="built_in">println</span>(<span class="string">"&#125;"</span>);</span><br><span class="line">        out.<span class="built_in">flush</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnabled</span><span class="params">(<span class="keyword">boolean</span> enabled)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        super.setEnabled(enabled);</span><br><span class="line">        JMSConnectionStatsImpl stats[] = getConnections();</span><br><span class="line">        <span class="keyword">int</span> <span class="built_in">size</span> = stats.length;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">size</span>; i++)</span><br><span class="line">            stats[i].setEnabled(enabled);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.2.2.2 ActiveMQConnection的构造</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="constructor">ActiveMQConnection(<span class="params">final</span> Transport <span class="params">transport</span>, IdGenerator <span class="params">clientIdGenerator</span>, IdGenerator <span class="params">connectionIdGenerator</span>, JMSStatsImpl <span class="params">factoryStats</span>)</span> throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    this.transport = transport;</span><br><span class="line">    this.clientIdGenerator = clientIdGenerator;</span><br><span class="line">    this.factoryStats = factoryStats;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure a single threaded executor who's core thread can timeout if</span></span><br><span class="line">    <span class="comment">// idle</span></span><br><span class="line">    executor = <span class="keyword">new</span> <span class="constructor">ThreadPoolExecutor(1, 1, 5, TimeUnit.SECONDS, <span class="params">new</span> LinkedBlockingQueue&lt;Runnable&gt;()</span>, <span class="keyword">new</span> <span class="constructor">ThreadFactory()</span> &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Thread <span class="keyword">new</span><span class="constructor">Thread(Runnable <span class="params">r</span>)</span> &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> <span class="constructor">Thread(<span class="params">r</span>, <span class="string">"ActiveMQ Connection Executor: "</span> + <span class="params">transport</span>)</span>;</span><br><span class="line">            <span class="comment">//守护线程，用于关闭，检测心跳等 - see https://issues.apache.org/jira/browse/AMQ-796</span></span><br><span class="line">            <span class="comment">//thread.setDaemon(true);</span></span><br><span class="line">            return thread;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">	<span class="comment">//连接信息，赋值</span></span><br><span class="line">    <span class="comment">// asyncConnectionThread.allowCoreThreadTimeOut(true);</span></span><br><span class="line">    String uniqueId = connectionIdGenerator.generate<span class="constructor">Id()</span>;</span><br><span class="line">    this.info = <span class="keyword">new</span> <span class="constructor">ConnectionInfo(<span class="params">new</span> ConnectionId(<span class="params">uniqueId</span>)</span>);</span><br><span class="line">    this.info.set<span class="constructor">Manageable(<span class="params">true</span>)</span>;</span><br><span class="line">    this.info.set<span class="constructor">FaultTolerant(<span class="params">transport</span>.<span class="params">isFaultTolerant</span>()</span>);</span><br><span class="line">    this.connectionSessionId = <span class="keyword">new</span> <span class="constructor">SessionId(<span class="params">info</span>.<span class="params">getConnectionId</span>()</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    this.transport.set<span class="constructor">TransportListener(<span class="params">this</span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//sessions 也是一个 CopyOnWriteArrayList，用于保存session，启动时size = 0</span></span><br><span class="line">    this.stats = <span class="keyword">new</span> <span class="constructor">JMSConnectionStatsImpl(<span class="params">sessions</span>, <span class="params">this</span> <span class="params">instanceof</span> XAConnection)</span>;</span><br><span class="line">    this.factoryStats.add<span class="constructor">Connection(<span class="params">this</span>)</span>;</span><br><span class="line">    this.timeCreated = <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span>;</span><br><span class="line">    this.connectionAudit.set<span class="constructor">CheckForDuplicates(<span class="params">transport</span>.<span class="params">isFaultTolerant</span>()</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-session-connection-createSession-true-Session-SESSION-TRANSACTED"><a href="#2-3-session-connection-createSession-true-Session-SESSION-TRANSACTED" class="headerlink" title="2.3 session = connection.createSession(true, Session.SESSION_TRANSACTED);"></a>2.3 session = connection.createSession(true, Session.SESSION_TRANSACTED);</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;该方法返回一个seesion，该session用于操作activemq，该方法先做了保护性校验查看连接是否关闭，如果没有，那么将ConnectionInfo发送给broker，没有异常情况下，new 一个 Session对象返回</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Session <span class="title">createSession</span><span class="params">(<span class="keyword">boolean</span> transacted, <span class="keyword">int</span> acknowledgeMode)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">    checkClosedOrFailed();</span><br><span class="line">    ensureConnectionInfoSent();</span><br><span class="line">    <span class="keyword">if</span> (!transacted) &#123;</span><br><span class="line">        <span class="keyword">if</span> (acknowledgeMode == Session.SESSION_TRANSACTED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JMSException(<span class="string">"acknowledgeMode SESSION_TRANSACTED cannot be used for an non-transacted Session"</span>);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(acknowledgeMode &lt; Session.SESSION_TRANSACTED || acknowledgeMode &gt; ActiveMQSession.MAX_ACK_CONSTANT)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JMSException(<span class="string">"invalid acknowledgeMode: "</span> + acknowledgeMode + <span class="string">". Valid values are Session.AUTO_ACKNOWLEDGE (1), "</span> +</span><br><span class="line">                    <span class="string">"Session.CLIENT_ACKNOWLEDGE (2), Session.DUPS_OK_ACKNOWLEDGE (3), ActiveMQSession.INDIVIDUAL_ACKNOWLEDGE (4) or for transacted sessions Session.SESSION_TRANSACTED (0)"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActiveMQSession(<span class="keyword">this</span>, getNextSessionId(), transacted ? Session.SESSION_TRANSACTED : acknowledgeMode, isDispatchAsync(), isAlwaysSessionAsync());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-分析sendMessage-方法"><a href="#3-分析sendMessage-方法" class="headerlink" title="3 分析sendMessage()方法"></a>3 分析sendMessage()方法</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;这个方法基本上就属于业务层了，你需要关心的是Queue，Topic。<br>可参考<a href="http://usql.club/2018/06/17/middleware/activemq-simple/" target="_blank" rel="noopener">点击查看</a></p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=https://github.com/farawayliu&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>far</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2018/07/21/middleware/activemq-producter/">https://www.ofcoder.com/2018/07/21/middleware/activemq-producter/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 2021 ofcoder. Author by far.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.ofcoder.com/2018/07/21/middleware/activemq-producter/" data-id="ckxoviwxf001eycj16g2s9ew9" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACuUlEQVR42u3aQW7kMAwEwPz/01lgTwvsjNIkRWcO5VMwMGyVDyLT4tdXfH3/vc6/f/9z5U/7//53z0ye3Lzw8PDwWkt/d+WLOD/5/JzqGpL78fDw8LZ5+fads/PNPflA+QfFw8PD+xxegjn/nnyCeSnCw8PD+xzeuZ3NF9ErPHh4eHifxksWnReGXgE4v3c9a8HDw8OLedUDsE/4e/F8Dw8PD29wqn6rYJw37upBWmGFeHh4eAu86rDUfDArb7uT3T4qGHh4eHhXeb2Rpl400BuiyocPXrjw8PDwlnl3Y4tJU1795YdmGg8PD+8qr7opT8KFXmlJmunCfwx4eHh4V3l5kJoj5+11Eg3/QMXDw8Nb4+Ub+jyEnTT0+QfFw8PD2+CdX5a/fjIW0DuEi+7Ew8PDW+P1RqZ6hWQS9eZjBy9myvDw8PAu8fKtuRe85iNZvWa9UE7w8PDwrvKqo07VELYX1+ZPKGQteHh4eI/weoNWOaYXjhSaeDw8PLwFXvUf/urLkrjhbgiCh4eHt8fLS0IvaEii2+bhVlKc8PDw8BZ4tzb6JOrN2+hJ2PH2A+Hh4eFd5fWW1WvH85Y6P4QrDw3g4eHhDXjJ63vtbzUUTth5446Hh4f3JC9pdvNQoPfkauwbBRB4eHh4l3jVJjgvIXm7fKvkNAcI8PDw8Aa83jhU9YB/Uip6RQgPDw9vg9cbA01KSHJgdouKh4eH9zxvsn1XA4U8ROgNYOHh4eHt8XqLyI+penfmn+xcovDw8PA2eBtt962D/zzgKB+D4eHh4Y15+abca69vtct5oXoxeoWHh4e3wOsVg/nx2Lx2lach8PDw8B7nzVvhfMhgHkzg4eHh/S5vEqHmwwe9CBgPDw/veV710OvcyOZhRPUYrBxk4OHh4S3wqgdg1RChOm6Vk3rxMR4eHt6A9wfDAu4DLvFvQQAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/ActiveMQ/">ActiveMQ</a><a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">源码解析</a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></div><div class="post-nav"><a class="pre" href="/2018/07/21/sql/antipatterns/06-%E5%AE%9E%E4%BD%93-%E5%B1%9E%E6%80%A7-%E5%80%BC/">SQL反模式06-实体-属性-值</a><a class="next" href="/2018/07/17/theory/RSA%20%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86/">数据安全02-RSA 加密原理</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'s8pJruGkXvi5Skd0e6EaMQ5X-gzGzoHsz',
  appKey:'K3NjnXxqhPNwUw5pmqOzoO4i',
  placeholder:'说出你的故事...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-抛开spring，创建一个简单生产者"><span class="toc-number">1.</span> <span class="toc-text">1 抛开spring，创建一个简单生产者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-安装windows版activemq"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 安装windows版activemq</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-生产者"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 生产者</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-分析init-方法"><span class="toc-number">2.</span> <span class="toc-text">2 分析init()方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-connectionFactory-new-ActiveMQConnectionFactory-USERNAME-PASSWORD-BROKEN-URL"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 connectionFactory &#x3D; new ActiveMQConnectionFactory(USERNAME, PASSWORD, BROKEN_URL);</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-connection-connectionFactory-createConnection"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 connection &#x3D; connectionFactory.createConnection();</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-创建Transport，createTransport"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 创建Transport，createTransport()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-由transport和状态管理器创建连接"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 由transport和状态管理器创建连接</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-session-connection-createSession-true-Session-SESSION-TRANSACTED"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 session &#x3D; connection.createSession(true, Session.SESSION_TRANSACTED);</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-分析sendMessage-方法"><span class="toc-number">3.</span> <span class="toc-text">3 分析sendMessage()方法</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">并发笔记 - ofcoder.com | </a><a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">粤ICP备18053760号</a><div>本站访客 <span id="busuanzi_value_site_uv"></span>人次 | 总访问 <span id="busuanzi_value_site_pv"></span>次<img src="https://s04.flagcounter.com/count/MnzJ/bg_FFFFFF/txt_000000/border_726EE0/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" style="display: none;"/></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.7" zIndex="-1" count="5" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>