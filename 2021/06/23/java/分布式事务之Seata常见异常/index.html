<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>分布式事务之Seata常见异常 | 并发笔记 - ofcoder.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><!-- 顶部加载进度条 --><script type="text/javascript" src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">分布式事务之Seata常见异常</h1><a id="logo" href="/.">并发笔记 - ofcoder.com</a><p class="description">一位后端开发的养肝历程，护发经验</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/usql/"><i class="fa fa-database"> usql</i></a><a href="/book/"><i class="fa fas fa-book"> book</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">分布式事务之Seata常见异常</h1><div class="post-meta">Jun 23, 2021<span> | </span><span class="category"><a href="/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/">踩坑日记</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 450</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 1</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2021/06/23/java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8BSeata%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8/#vcomment"><span class="valine-comment-count" data-xid="/2021/06/23/java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8BSeata%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8/"></span><span> 条评论</span></a><div class="post-content"><h3 id="关于log-status-1的记录"><a href="#关于log-status-1的记录" class="headerlink" title="关于log_status=1的记录"></a>关于log_status=1的记录</h3><p>网上都说是防悬挂，具体是指啥又没说清楚。这里先说结论：这个条记录，你可以不用管它。</p>
<p>防悬挂，因为网络延迟或者第一阶段请求丢包，导致第二阶段的回滚请求，先到RM，RM此时没有处理第一阶段请求，没有记录undo_log，所以插入该记录，作为一个防御性的操作，阻止后到的第一阶段请求继续执行。</p>
<p>产生的另一个原因是，请检查项目中是否为多数据源。如果是，需要把seata自动代理关了，一般多数据源都是有开发者已经手动代理了。二阶段的时候，下发找datasource，找到的不是你业务操作数据库的datasource，导致没发现undolog，就插了一条status=1。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭自动代理</span></span><br><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">enable-auto-data-source-proxy:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="关于log-status-0的记录"><a href="#关于log-status-0的记录" class="headerlink" title="关于log_status=0的记录"></a>关于log_status=0的记录</h3><p>seata-server宕机后，分支事务的undo_log中将出现log_status=0的记录，重新seata-server后，会自动处理掉这些日志。</p>
<h3 id="异常：ShouldNeverHappenException"><a href="#异常：ShouldNeverHappenException" class="headerlink" title="异常：ShouldNeverHappenException"></a>异常：ShouldNeverHappenException</h3><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Error </span>preparing statement. Cause: io.seata.common.exception.ShouldNeverHappenException: [xid:172.19.0.204:8091:9483xxxxxxxxx]get tablemeta failed</span><br></pre></td></tr></table></figure>
<p>解决方案：检查表是否存在。</p>
<h3 id="异常：SQLJoinTableSource"><a href="#异常：SQLJoinTableSource" class="headerlink" title="异常：SQLJoinTableSource"></a>异常：SQLJoinTableSource</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.ClassCastException</span>: <span class="selector-tag">com</span><span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.sql</span><span class="selector-class">.ast</span><span class="selector-class">.statement</span><span class="selector-class">.SQLJoinTableSource</span> <span class="selector-tag">cannot</span> <span class="selector-tag">be</span> <span class="selector-tag">cast</span> <span class="selector-tag">to</span> <span class="selector-tag">com</span><span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.sql</span><span class="selector-class">.ast</span><span class="selector-class">.statement</span><span class="selector-class">.SQLExprTableSource</span>;</span><br></pre></td></tr></table></figure>
<p>出现原因：update语句不能join其他表。</p>
<h3 id="异常：TmTransactionException"><a href="#异常：TmTransactionException" class="headerlink" title="异常：TmTransactionException"></a>异常：TmTransactionException</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Failed</span> <span class="selector-tag">to</span> <span class="selector-tag">begin</span> <span class="selector-tag">transaction</span>. </span><br><span class="line"><span class="selector-tag">io</span><span class="selector-class">.seata</span><span class="selector-class">.core</span><span class="selector-class">.exception</span><span class="selector-class">.TmTransactionException</span>: <span class="selector-tag">TransactionException</span><span class="selector-attr">[Fail to store global session]</span></span><br><span class="line">....</span><br><span class="line"><span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.UndeclaredThrowableException</span>: <span class="selector-tag">null</span></span><br></pre></td></tr></table></figure>
<p>查看seata-server是否抛出类似的错误：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">writeSession <span class="keyword">error</span>, <span class="keyword">global</span> session <span class="keyword">size</span> exceeded, <span class="keyword">size</span> : <span class="number">566</span> maxBranchSessionSize : <span class="number">512</span></span><br></pre></td></tr></table></figure>
<p>解决方案：开启全局事务的方法入参太多。</p>
<h3 id="异常：TransactionException"><a href="#异常：TransactionException" class="headerlink" title="异常：TransactionException"></a>异常：TransactionException</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TransactionException[Could <span class="keyword">not</span> register branch <span class="built_in">int</span>o global session xid = <span class="number">172.32</span><span class="number">.1</span><span class="number">.161</span>:<span class="number">8091</span>:<span class="number">113670</span>****<span class="number">4512</span> status = AsyncComm ]</span><br></pre></td></tr></table></figure>
<p>产生原因：在 @GlobalTransactional 的外面使用 @Transactional 修饰了，例如：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">aaa</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	bbb();	</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">bbb</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=https://github.com/farawayliu&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>far</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2021/06/23/java/分布式事务之Seata常见异常/">https://www.ofcoder.com/2021/06/23/java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8BSeata%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 并发笔记 - ofcoder.com. Author by far.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.ofcoder.com/2021/06/23/java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8BSeata%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8/" data-id="ckxoviwwx000rycj17qj94b7z" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASYAAAEmCAAAAADqr2IGAAAEoUlEQVR42u3ay27iQBAF0Pz/T2ek2WaAe6tgQpvjVRSI3X0cqev19RVf33+v5Odbv/l53b/D/b/6ubb801vffMKFCRMmTJjekqndzK2/us+a3K3dZAu6ugMmTJgwYTqcKb9d8rD79589Mbln+/T8/pgwYcKE6ROY8gQ13+T97eWvJ0fBhAkTJkyYZsfzrKQ7q6/m32lTekyYMGHCdFWm5HazsCBf7ibdnSXnL6mFY8KECROmN2N67uDOWT//2nwTJkyYMGH6L0ybcu3m6H1dcrs5/m/uGhMmTJgwHcu0GRjNEdtW4izdzUOBWYMTEyZMmDCdyHR/kxv7BHqWaebDpnlQUsRNmDBhwoTpKKZ8e5v0NSebpc152NGGIJgwYcKE6UpMszGaZ6WgT3jD8VPaVB8TJkyYMJ3LlKSO+6Jtu/RNytqWiaMVYsKECROmY5na282KubNGZsuXhy+rJBkTJkyYMB3OlCexeVOwbVvmAUdeIJ7VAx4M8WDChAkTpkOYZmnnpuCbhCCveEntGoaxCSZMmDBhehum2ejMbDQnP/LblLtN2vOnYMKECROm05nygzkvnuaBwiyVTZ7+rNIwJkyYMGG6BlNy0M5Ch7bM2q4nv1vevIzgMGHChAnTsUzPLZjmifFsY7NidM4U/U9hwoQJE6a3Z9o/oD1u85Jrm5a3qXWxWkyYMGHCdCxTW5Btt7ov+7bDOu1TigQYEyZMmDAdyFQ38+JxmTzIaJ/VBg1fowsTJkyYMJ3OtGlYJillHo/sm6N52bdN1zFhwoQJ07WZ2iJvW7RtofN25mboBxMmTJgwXYNpf3DmIzhJkjlrrLaF6dmLxIQJEyZMJzLlBdnkeM7hWr5Z0jsrKEdFXkyYMGHCdAjTrCnYDtAkYceqCBunxO06MWHChAnTtZmSBLVNNfPAYjPG2rZUi4AGEyZMmDAdxZQ/vm0KJmXffEubdDpvoD4Y3MGECRMmTMcy5Uts/6rdzDAdXZRxV1UBTJgwYcL09kz7DeQF1s0ATR4ibF5nkhJjwoQJE6azmJKi6qzp2B7hbUk3fzF5ofnmczFhwoQJ07FMeVo4Y8230S69HQBqX0yNhQkTJkyY3pipHb5pB3eSw7sNLzbrHFYIMGHChAnTgUyz5DZvIiZJbFJ7zuOXTcpdx0SYMGHChOkQprag2S46Dwhm40RJAXf2fUyYMGHCdA2m5DBOPk2Wtd/w5g5547NIfTFhwoQJ01FM+6SxXW578rZ8yWt7sB5MmDBhwnQJpmSreUl3Fhbkv5kN6OTjQf/o92LChAkTpgOZZqns676frypPj9vwIloVJkyYMGE6hOm7vJJwIR8zzUOQ2WE/+7R4S5gwYcKE6e2ZZsM6eUqcLyU5zvcl3bwhigkTJkyYrsSUBwFJYtke2G0ztW1JtnwPKuKYMGHChOlYpjwImLUt25Jr/kpm4UJdSsaECRMmTB/ANBvuycnyAz5JxTeDRzebmpgwYcKE6QOYWr62PZknye03V8EKJkyYMGE6nOlZwzr71mPeCs1f0v71YMKECROmc5lmxda2vNsO97zigG8DlNV8EyZMmDBh+n2mPzqj1GVumcXVAAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/%E5%B9%B2%E8%B4%A7/">干货</a><a href="/tags/maven/">maven</a><a href="/tags/HTTPS/">HTTPS</a></div><div class="post-nav"><a class="pre" href="/2021/07/29/machinelearn/PaddleOCR-PaddleServing%E9%83%A8%E7%BD%B2/">PaddleOCR - PaddleServing部署</a><a class="next" href="/2021/04/11/sql/SQL%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E5%AD%97%E7%AC%A6%E4%B8%B2/">SQL生成随机字符串</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'s8pJruGkXvi5Skd0e6EaMQ5X-gzGzoHsz',
  appKey:'K3NjnXxqhPNwUw5pmqOzoO4i',
  placeholder:'说出你的故事...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#关于log-status-1的记录"><span class="toc-number">1.</span> <span class="toc-text">关于log_status&#x3D;1的记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于log-status-0的记录"><span class="toc-number">2.</span> <span class="toc-text">关于log_status&#x3D;0的记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异常：ShouldNeverHappenException"><span class="toc-number">3.</span> <span class="toc-text">异常：ShouldNeverHappenException</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异常：SQLJoinTableSource"><span class="toc-number">4.</span> <span class="toc-text">异常：SQLJoinTableSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异常：TmTransactionException"><span class="toc-number">5.</span> <span class="toc-text">异常：TmTransactionException</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异常：TransactionException"><span class="toc-number">6.</span> <span class="toc-text">异常：TransactionException</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">并发笔记 - ofcoder.com | </a><a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">粤ICP备18053760号</a><div>本站访客 <span id="busuanzi_value_site_uv"></span>人次 | 总访问 <span id="busuanzi_value_site_pv"></span>次<img src="https://s04.flagcounter.com/count/MnzJ/bg_FFFFFF/txt_000000/border_726EE0/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" style="display: none;"/></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>