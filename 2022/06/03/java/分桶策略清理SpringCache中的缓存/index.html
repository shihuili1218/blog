<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>分桶策略清理SpringCache中的缓存 | 并发笔记 - ofcoder.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><!-- 顶部加载进度条 --><script type="text/javascript" src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">分桶策略清理SpringCache中的缓存</h1><a id="logo" href="/.">并发笔记 - ofcoder.com</a><p class="description">一位后端开发的养肝历程，护发经验</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/book/"><i class="fa fas fa-book"> book</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">分桶策略清理SpringCache中的缓存</h1><div class="post-meta">Jun 3, 2022<span> | </span><span class="category"><a href="/categories/%E8%8A%9D%E5%A3%AB%E7%82%B9%E5%BF%83/">芝士点心</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 982</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 4</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2022/06/03/java/%E5%88%86%E6%A1%B6%E7%AD%96%E7%95%A5%E6%B8%85%E7%90%86SpringCache%E4%B8%AD%E7%9A%84%E7%BC%93%E5%AD%98/#vcomment"><span class="valine-comment-count" data-xid="/2022/06/03/java/%E5%88%86%E6%A1%B6%E7%AD%96%E7%95%A5%E6%B8%85%E7%90%86SpringCache%E4%B8%AD%E7%9A%84%E7%BC%93%E5%AD%98/"></span><span> 条评论</span></a><div class="post-content"><h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><p>我们使用SpringCache框架 + Redis来实现项目中的缓存实现，它能实现自动对数据缓存，也可以自动清理过期的缓存。大多数情况下，它都运行非常好。</p>
<p>这是因为我们需要缓存的数据，通常都是可序列化的，但是我们迟早会遇到不可序列化的对象。那么我们只能选择SpringCache中的ConcurrentMapCache才能缓存这些不可序列化的对象，但是ConcurrentMapCache呢又不提供自动清理缓存的功能。</p>
<p>于是我开始自己设计一个本地的、高效的、能自动清理缓存扩展，同样它能支持SpringCache。</p>
<p>为了高效的清理缓存，我采用分桶策略，这一设计思想来源于ZooKeeper的Session管理。分桶策略也是本文的精彩内容。</p>
<h3 id="SpringCache的使用"><a href="#SpringCache的使用" class="headerlink" title="SpringCache的使用"></a>SpringCache的使用</h3><h4 id="SpringCache-Redis自动清理缓存"><a href="#SpringCache-Redis自动清理缓存" class="headerlink" title="SpringCache + Redis自动清理缓存"></a>SpringCache + Redis自动清理缓存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheAutoConfiguration</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory redisConnectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"redisCacheManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager cacheManager = <span class="keyword">new</span> RedisCacheManager(</span><br><span class="line">                RedisCacheWriter.nonLockingRedisCacheWriter(redisConnectionFactory),</span><br><span class="line">                getTtlRedisCacheConfiguration(CacheNameEnum.DEFAULT),</span><br><span class="line">                getCustomizeTtlRedisCacheConfigurationMap());</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, RedisCacheConfiguration&gt; <span class="title">getCustomizeTtlRedisCacheConfigurationMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, RedisCacheConfiguration&gt; redisCacheConfigurationMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (CacheNameEnum cacheNameEnum : CacheNameEnum.values()) &#123;</span><br><span class="line">            redisCacheConfigurationMap.put(cacheNameEnum.name(), getTtlRedisCacheConfiguration(cacheNameEnum));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisCacheConfigurationMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RedisCacheConfiguration <span class="title">getTtlRedisCacheConfiguration</span><span class="params">(CacheNameEnum cacheNameEnum)</span> </span>&#123;</span><br><span class="line">        GenericFastJsonRedisSerializer fastJsonRedisSerializer = <span class="keyword">new</span> GenericFastJsonRedisSerializer();</span><br><span class="line">        StringRedisSerializer stringRedisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line"></span><br><span class="line">        RedisSerializationContext.SerializationPair&lt;Object&gt; objectSerializationPair = RedisSerializationContext.SerializationPair.fromSerializer(fastJsonRedisSerializer);</span><br><span class="line">        RedisSerializationContext.SerializationPair&lt;String&gt; stringSerializationPair = RedisSerializationContext.SerializationPair.fromSerializer(stringRedisSerializer);</span><br><span class="line"></span><br><span class="line">        RedisCacheConfiguration redisCacheConfiguration = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">        redisCacheConfiguration = redisCacheConfiguration.serializeKeysWith(stringSerializationPair)</span><br><span class="line">                .serializeValuesWith(objectSerializationPair)</span><br><span class="line">                .entryTtl(Duration.ofSeconds(cacheNameEnum.getTtl()));</span><br><span class="line">        <span class="keyword">return</span> redisCacheConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> CacheNameEnum &#123;</span><br><span class="line">        DEFAULT(<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> ttl;</span><br><span class="line"></span><br><span class="line">        CacheNameEnum(<span class="keyword">int</span> ttl) &#123;</span><br><span class="line">            <span class="keyword">this</span>.ttl = ttl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTtl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ttl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么使用的时候，就只需要增加注解就行了</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> @<span class="constructor">Cacheable(<span class="params">cacheManager</span> = <span class="string">"redisCacheManager"</span>, <span class="params">cacheNames</span> = <span class="string">"DEFAULT"</span>, <span class="params">key</span> = <span class="string">"'nft:transafer:' + #mnemonic"</span>)</span></span><br><span class="line">public Transafer recover(String mnemonic) &#123;</span><br><span class="line">    return <span class="keyword">new</span> <span class="constructor">Transafer(<span class="params">mnemonic</span>, <span class="params">wenchangChainPropertity</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SpringCache-Map本地缓存"><a href="#SpringCache-Map本地缓存" class="headerlink" title="SpringCache + Map本地缓存"></a>SpringCache + Map本地缓存</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 记得加上@EnableCaching，开启缓存</span></span><br><span class="line">@<span class="constructor">Bean(<span class="string">"localCacheManager"</span>)</span></span><br><span class="line">public CacheManager local<span class="constructor">CacheManager()</span> &#123;</span><br><span class="line">    ConcurrentMapCache publicKeyCache = <span class="keyword">new</span> <span class="constructor">ConcurrentMapCache(<span class="string">"localCache"</span>)</span>;</span><br><span class="line">    Set&lt;Cache&gt; caches = <span class="keyword">new</span> HashSet&lt;&gt;<span class="literal">()</span>;</span><br><span class="line">    caches.add(publicKeyCache);</span><br><span class="line"></span><br><span class="line">    SimpleCacheManager cacheManager = <span class="keyword">new</span> <span class="constructor">SimpleCacheManager()</span>;</span><br><span class="line">    cacheManager.set<span class="constructor">Caches(<span class="params">caches</span>)</span>;</span><br><span class="line">    return cacheManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么使用的时候，就只需要增加注解就行了</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> @<span class="constructor">Cacheable(<span class="params">cacheManager</span> = <span class="string">"localCacheManager"</span>, <span class="params">cacheNames</span> = <span class="string">"localCache"</span>, <span class="params">key</span> = <span class="string">"'nft:transafer:' + #mnemonic"</span>)</span></span><br><span class="line">public Transafer recover(String mnemonic) &#123;</span><br><span class="line">    return <span class="keyword">new</span> <span class="constructor">Transafer(<span class="params">mnemonic</span>, <span class="params">wenchangChainPropertity</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SpringCache-Map自动清理本地缓存"><a href="#SpringCache-Map自动清理本地缓存" class="headerlink" title="SpringCache + Map自动清理本地缓存"></a>SpringCache + Map自动清理本地缓存</h4><p>为了实现自动清理缓存，我继承了ConcurrentMapCache，采用分桶策略，定时清理。</p>
<ul>
<li>expirationInterval，桶的估计范围，如果为1分钟，那么1分钟内创建的缓存都存在一个桶，例如16:11:20和16:11:01，都会存放在16:12:00这个桶中。</li>
<li>roundToNextInterval，用于根据当前时间计算，下一个桶的时间。</li>
<li>executorService，用于清理缓存，仅仅在创建桶时，调用其该线程，并不会实时运行，占用CPU资源。</li>
</ul>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class LocalExpiryCache extends ConcurrentMapCache &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger <span class="built_in">log</span> = LoggerFactory.getLogger(LocalExpiryCache.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 桶的范围</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> expirationInterval;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ScheduledExecutorService executorService = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">5</span>, NftThreadFactory.create(<span class="string">"cache-cleara"</span>, <span class="keyword">true</span>));</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, Set&lt;<span class="keyword">Object</span>&gt;&gt; expiryMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LocalExpiryCache(<span class="keyword">String</span> name, <span class="keyword">long</span> expirationInterval) &#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        <span class="keyword">this</span>.expirationInterval = expirationInterval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> put(<span class="keyword">Object</span> <span class="built_in">key</span>, <span class="keyword">Object</span> value) &#123;</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"=======put======="</span>);</span><br><span class="line">        <span class="keyword">super</span>.put(<span class="built_in">key</span>, value);</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">long</span> expires = roundToNextInterval(now);</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"expires: "</span> + DateUtil.formatDate(<span class="keyword">new</span> Date(expires), DateUtil.FORMAT_DATETIME_NORMAL));</span><br><span class="line">        <span class="keyword">if</span> (!expiryMap.containsKey(expires)) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!expiryMap.containsKey(expires)) &#123;</span><br><span class="line">                    expiryMap.put(expires, <span class="keyword">new</span> ConcurrentHashSet&lt;&gt;());</span><br><span class="line">                    executorService.schedule((Runnable) <span class="keyword">this</span>::expiry, expires - now + <span class="number">100</span></span><br><span class="line">                            , TimeUnit.MILLISECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;<span class="keyword">Object</span>&gt; objects = expiryMap.<span class="built_in">get</span>(expires);</span><br><span class="line">        objects.<span class="built_in">add</span>(<span class="built_in">key</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> ValueWrapper putIfAbsent(<span class="keyword">Object</span> <span class="built_in">key</span>, <span class="keyword">Object</span> value) &#123;</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"=======putIfAbsent======="</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.putIfAbsent(<span class="built_in">key</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> roundToNextInterval(<span class="keyword">long</span> time) &#123;</span><br><span class="line">        <span class="keyword">return</span> (time / expirationInterval + <span class="number">1</span>) * expirationInterval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set expiry() &#123;</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"-------------------------------------"</span>);</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        Set&lt;Long&gt; ttls = expiryMap.keySet();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ttls)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line">        Iterator&lt;Long&gt; iterator = ttls.iterator();</span><br><span class="line">        Set result = <span class="keyword">new</span> HashSet();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            Long expirationTime = iterator.next();</span><br><span class="line">            <span class="keyword">if</span> (now &lt; expirationTime) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            result.addAll(expiryMap.<span class="built_in">get</span>(expirationTime));</span><br><span class="line">            iterator.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">Object</span> <span class="built_in">key</span> : result) &#123;</span><br><span class="line">            <span class="keyword">super</span>.evict(<span class="built_in">key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"evict size: "</span> + result.<span class="built_in">size</span>());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        LocalExpiryCache localCache = <span class="keyword">new</span> LocalExpiryCache(<span class="string">""</span>, <span class="number">1</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">        localCache.put(<span class="string">"1"</span>, <span class="string">""</span>);</span><br><span class="line">        localCache.put(<span class="string">"2"</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span>.info(localCache.getNativeCache().<span class="built_in">size</span>() + <span class="string">""</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">log</span>.info(localCache.getNativeCache().<span class="built_in">size</span>() + <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        localCache.put(<span class="string">"2"</span>, <span class="string">""</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">log</span>.info(localCache.getNativeCache().<span class="built_in">size</span>() + <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用时，用LocalExpiryCache替换掉ConcurrentMapCache即可</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@<span class="constructor">Bean(<span class="string">"localCacheManager"</span>)</span></span><br><span class="line">public CacheManager local<span class="constructor">CacheManager()</span> &#123;</span><br><span class="line">    LocalExpiryCache publicKeyCache = <span class="keyword">new</span> <span class="constructor">LocalExpiryCache(<span class="string">"localCache"</span>, 1 <span class="operator">*</span> 60 <span class="operator">*</span> 1000)</span>;</span><br><span class="line">    Set&lt;Cache&gt; caches = <span class="keyword">new</span> HashSet&lt;&gt;<span class="literal">()</span>;</span><br><span class="line">    caches.add(publicKeyCache);</span><br><span class="line"></span><br><span class="line">    SimpleCacheManager cacheManager = <span class="keyword">new</span> <span class="constructor">SimpleCacheManager()</span>;</span><br><span class="line">    cacheManager.set<span class="constructor">Caches(<span class="params">caches</span>)</span>;</span><br><span class="line">    return cacheManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=https://github.com/farawayliu&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>far</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2022/06/03/java/分桶策略清理SpringCache中的缓存/">https://www.ofcoder.com/2022/06/03/java/%E5%88%86%E6%A1%B6%E7%AD%96%E7%95%A5%E6%B8%85%E7%90%86SpringCache%E4%B8%AD%E7%9A%84%E7%BC%93%E5%AD%98/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 并发笔记 - ofcoder.com. Author by far.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.ofcoder.com/2022/06/03/java/%E5%88%86%E6%A1%B6%E7%AD%96%E7%95%A5%E6%B8%85%E7%90%86SpringCache%E4%B8%AD%E7%9A%84%E7%BC%93%E5%AD%98/" data-id="cl3y6dabq0000koj13x7z5wmc" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASYAAAEmCAAAAADqr2IGAAAErklEQVR42u3awW7bQAwEUP//T7tATynaODOkgnqVp1OQ2LL3KcCSw3084uv5+/r488frs99//Ovf90nu/PfrX7/3s9ckr7zgwoQJEyZMb8n0fHnNmF6/a7bg/K8tbvR4MGHChAnT4UyzIiDfdPPNO/nEHGj/TTBhwoQJ089hShrUpAhI3jUrMvLWGhMmTJgwYWoLgtftdNvi5inrVQ8VEyZMmDDdmym5Xd5GJsPFPDjOH8bs/hdn4ZgwYcKE6c2YZgd37vHzt59vwoQJEyZM/5XpWV6zMeGmUGiLic32/+mqMWHChAnTsUzJgpPDMZvIOC9EWtCrBqKYMGHChOlcpjxCnY0Y2w27DV43EXDxSkyYMGHCdCxTXTssDtAk5UU7TM3vmZc+n74eEyZMmDDdgqltg9tlfPfrN4eNvmi8MWHChAnTgUyz5nA2mLxqOLoJfPOC5ov/I0yYMGHCdCzTJmbdt6Cz0WN76KduszFhwoQJ07FMyS3aBng2Ct1HtAn07KASJkyYMGE6l+kZX0lLuQlkk/e2zfCm5S4SAkyYMGHC9PZM+TI2zWTbym6a8Pbg0aN9npgwYcKE6SimPO7Mx4oJTTtobIPdTTT8x+8xYcKECdPhTJuP35QOq2R68SCTMuWRZ8mYMGHChOmNmTZjwvbrziLd2Tizbeaj9WLChAkTpmOZkk19duwm34zbIWjSridt86qGwoQJEyZMb88022Lbd+VBbbuwWRzclgWYMGHChOlcprxp3MemeZibtMezYLe9MGHChAnTnZjypnQf6c42/rwcyVvxYhWYMGHChOlApk0q/AyudvOejVc3CXdULmDChAkTpsOZrt3C8+Z2U3zkIW87QP1i0osJEyZMmA5kmsWgOdMmZm3LgrwVLz4REyZMmDAdy7SJPq86mtM+gPbBPOMrevyYMGHChOkopjzuTGj2TWbxVINHsnlsmDBhwoTpfkxt05hHsRu+GW57JKg42YQJEyZMmI5iysPNPGBt75aHtqslxZ/+2N8IEyZMmDC9DVMeiUajvvKrzBrj/LjPZevFhAkTJky3YJrFqW173BYZbTvdRtLDSS8mTJgwYTqKKR/7zY7jvF7AVQPRHLp+LyZMmDBhOpZpFnq2G+1VC5u12QlTVEZgwoQJE6YbMbVkSYlQf62Xnz7jywuUqCDAhAkTJkxvz5Q3tPm2uikIZpt6XkwMDwBhwoQJE6ZjmfbBbhsB5wPIPAJu0euKCRMmTJgwHcuUf8ym3c3Hn/vBZ9L0tt8cEyZMmDDdgym5XdKUzqDzhjmJofONP/rmmDBhwoTpWKZ8AfkWPjug036rZNmz8WcUYWPChAkTpkOY9kFtvoxri4nZfn3Z9o8JEyZMmA5hyq98OtoODvPt/PU9c46oMsKECRMmTDdimhUBbaucLLItJmYLzouSfxzfwYQJEyZMxzK1x2jyIzizQzntIHN2/6KBx4QJEyZMP4BpH+zm7XQe9dZb+ygaxoQJEyZMP4epbVzzBewj4/zAUF7KYMKECROmezAlC8jLgnwA2Q4dZ2VK28avsnBMmDBhwvRmTLODOy1f0nDmjXc7BK0j3avON2HChAkTpv/J9AtgIv0ujneXbgAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/%E7%BC%93%E5%AD%98/">缓存</a><a href="/tags/SpringCache/">SpringCache</a><a href="/tags/%E5%88%86%E6%A1%B6%E7%AD%96%E7%95%A5/">分桶策略</a></div><div class="post-nav"><a class="next" href="/2022/03/15/other/%E9%87%8A%E6%9C%AC%E6%99%BA%E5%A4%A7%E5%B8%88%E5%BC%80%E7%A4%BA/">释本智大师开示</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'s8pJruGkXvi5Skd0e6EaMQ5X-gzGzoHsz',
  appKey:'K3NjnXxqhPNwUw5pmqOzoO4i',
  placeholder:'说出你的故事...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#背景介绍"><span class="toc-number">1.</span> <span class="toc-text">背景介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringCache的使用"><span class="toc-number">2.</span> <span class="toc-text">SpringCache的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringCache-Redis自动清理缓存"><span class="toc-number">2.1.</span> <span class="toc-text">SpringCache + Redis自动清理缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringCache-Map本地缓存"><span class="toc-number">2.2.</span> <span class="toc-text">SpringCache + Map本地缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringCache-Map自动清理本地缓存"><span class="toc-number">2.3.</span> <span class="toc-text">SpringCache + Map自动清理本地缓存</span></a></li></ol></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">并发笔记 - ofcoder.com | </a><a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">粤ICP备18053760号</a><div>本站访客 <span id="busuanzi_value_site_uv"></span>人次 | 总访问 <span id="busuanzi_value_site_pv"></span>次<img src="https://s04.flagcounter.com/count/MnzJ/bg_FFFFFF/txt_000000/border_726EE0/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" style="display: none;"/></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>