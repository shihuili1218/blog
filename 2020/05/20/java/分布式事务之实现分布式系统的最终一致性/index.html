<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>分布式事务之实现分布式系统的最终一致性 | 并发笔记 - ofcoder.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><!-- 顶部加载进度条 --><script type="text/javascript" src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">分布式事务之实现分布式系统的最终一致性</h1><a id="logo" href="/.">并发笔记 - ofcoder.com</a><p class="description">一位后端开发的养肝历程，护发经验</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/book/"><i class="fa fas fa-book"> book</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">分布式事务之实现分布式系统的最终一致性</h1><div class="post-meta">May 20, 2020<span> | </span><span class="category"><a href="/categories/%E8%8A%9D%E5%A3%AB%E7%82%B9%E5%BF%83/">芝士点心</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.6k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 16</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2020/05/20/java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8B%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7/#vcomment"><span class="valine-comment-count" data-xid="/2020/05/20/java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8B%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7/"></span><span> 条评论</span></a><div class="post-content"><p>转载自： <a href="https://www.cnblogs.com/wudimanong/p/10558710.html" target="_blank" rel="noopener">https://www.cnblogs.com/wudimanong/p/10558710.html</a></p>
<h3 id="导读"><a href="#导读" class="headerlink" title="导读"></a>导读</h3><p>在之前的文章中我们介绍了如何基于RocketMQ搭建生产级消息集群，以及2PC、3PC和TCC等与分布式事务相关的基本概念（没有读过的读者详见👇推荐阅读）。在这篇文章中我们将介绍RocketMQ的事务消息相关的内容，并通过一些实践和大家一起来探索下事务消息如何解决分布式系统中的分布式事务问题。</p>
<h3 id="事务消息原理"><a href="#事务消息原理" class="headerlink" title="事务消息原理"></a>事务消息原理</h3><p>事务消息特性可以看作是<strong>两阶段协议</strong>的消息实现方式，用以确保在以<strong>消息中间件解耦</strong>的分布式系统中<strong>本地事务的执行和消息的发送</strong>，可以<strong>以原子的方式进行</strong>。</p>
<p>举个例子，以某互联网公司的用户余额充值为例，因为有充返活动（充值100元赠送20元），优惠比较大，用户Joe禁不住诱惑用支付宝向自己的余额账户充值了100元，支付成功后Joe的余额账户有了120元钱。</p>
<p>而该公司的关于用户余额充值的系统设计是这样的：<br><img src="/images/java/distributed-transaction-1.png" alt="原理"></p>
<p>在这个设计流程中，该公司通过自建支付系统完成用户Joe的支付宝扣款操作，成功后需要更新支付流水的状态，因为用户的<strong>余额账户系统与支付系统之间通过MQ解耦</strong>了，所以支付系统在完成支付流水状态更新后需要通过发送MQ消息到消息中间件服务，然后用户余额系统作为消费者通过消息消费的方式完成用户余额的增加操作。</p>
<p>这里有个问题：“<strong>支付系统如何确保这笔余额充值消息一定会成功发送到MQ，并且用户余额系统一定能处理成功呢</strong>”？如果支付系统在完成支付订单状态更新后，MQ<strong>消息发送失败</strong>或者用户<strong>余额系统消息处理失败</strong>的话，都会导致Joe支付扣款成功，而自己的余额账户却没到账的情况发生。</p>
<p>为了解决这个问题，按照目前的系统设计是需要“<strong>支付系统-MQ服务-用户余额系统</strong>”三者的处理满足数据的一致性要求。例如，如果支付系统感知到消息发送失败后还可以进行重新投递，从而确保支付系统与用户余额数据的最终一致性。</p>
<p>而上述问题就是事务消息要解决的问题，在具体了解RocketMQ提供的事务消息机制之前，我们先来看下在RocketMQ的早期版本不支持事务消息，或者因为历史原因选择的消息中间件本身就不支持事务消息的情况下，一些大公司是怎么解决这个问题的？</p>
<p>早期为了实现基于MQ异步调用的多个服务间，业务逻辑执行要么一起成功、要么一起失败，具备事务特点，通常会采用<strong>可靠消息最终一致性方案</strong>，来实现分布式事务。还是以Joe充值这件事来举例，可靠消息方案实现过程如下：<br><img src="/images/java/distributed-transaction-2.png" alt="原理"></p>
<p>在可靠消息最终一致性方案中，为了实现分布式事务，需要确保上游服务本地事务的处理与MQ消息的投递具有原子性，也就是说上游服务本地事务处理成功后要确保消息一定要成功投递到MQ服务，否则消息就不应该被投递到MQ服务；同样，被成功投递到MQ服务的消息，也一定要被下游服务成功处理，否则就需要重新投递MQ消息。</p>
<p>为了实现双向的原子性，可靠消息服务需要对<strong>消息进行状态标记</strong>，与此同时还需要对消息进行状态检查，从而实现重新投递及消息状态的最终一致性。核心流程说明如下：</p>
<p><font color='red'>1、上游服务（支付系统）如何确保完成自身支付成功状态更新后消息100%的能够投递到下游服务（用户余额系统）指定的Topic中？</font></p>
<p>在这个流程中上游服务在进行本地数据库事务操作前，会先发送一个状态为“<strong>待确认</strong>”的消息至可靠消息服务，而不是直接将消息投递到MQ服务的指定Topic。可靠消息服务此时会将该消息记录到自身服务的消息数据库中（<strong>消息状态为-&gt;待确认</strong>），完成后可靠消息服务会回调上游服务表示收到了消息，你们可以进行本地事务的操作了。</p>
<p>之后上游服务就会开启本地数据库事务执行业务逻辑操作，这里支付系统就会将该笔支付订单状态更新为“已成功”。（注意，这里只是举个示例场景，在真正的实践中一般是不会把支付订单本身的状态与业务端回调放在一个事务流程中的，关于这部分的详细说明我们在下面的场景说明中再讨论）。</p>
<p>如果上游服务本地数据库事务执行成功，则继续向可靠消息服务发送<strong>消息确认消息</strong>，此时可靠消息服务就会正式将消息投递到MQ服务，并且同时<strong>更新消息数据库中的消息状态为“已发送”</strong>。（注意，这里可靠消息服务更新消息状态与投递消息至MQ也必须是在一个原子操作中，即<strong>消息投递成功则一定要将消息状态更新为“已发送”</strong>，所以在编程的细节中，可靠消息服务一般会先更新消息状态，然后再进行消息投递，<strong>这样即使消息投递失败，也可以对消息状态进行回滚-&gt;“待确认”</strong>，相反如果先进行消息投递再更新消息状态，可能就不好控制了）。</p>
<p>相反，如果上游本地数据库事务执行失败，则需要向可靠消息服务发送<strong>消息删除消息</strong>，可靠消息服务此时就会将消息删除，这样就意味着事务在上游消息投递过程中就被回滚了，而流程也就此结束了，此时上游服务可以需要通过业务逻辑的设计进行重发，这个就不再分布式事务的讨论范畴了。</p>
<p>说到这里，大家可能会有疑问了！因为在上述描述中，即使上游服务本地数据库事务执行成功了，但是在发送确认消息至可靠消息服务的过程中，以及可靠消息服务在投递消息至MQ服务的过程中，还是会存在失败的风险，这样的话还是会导致支付服务更新了状态，但是用户余额系统连消息都没有收到的情况发生？</p>
<p>实际上，实现数据一致性是一个复杂的活。在这个方案中可靠消息服务作为基础性的服务除了执行正常的逻辑外，还得处理复杂的异常场景。在实现过程中可靠消息服务需要启动相应的后台线程，不断轮训消息的状态，这里会轮训消息状态为“<strong>待确认</strong>”的消息，并判断该消息的状态的持续时间是否超过了规定的时间，如果超过规定时间的消息还处于“待确认”的状态，就会触发<strong>上游服务状态询问机制</strong>。</p>
<p>可靠消息服务就会调用上游服务提供的相关借口，询问这笔消息的处理情况，如果这笔消息在上游服务处理成功，则后台线程就会继续触发上图中的步骤5，更新消息状态为“已发送”并投递消息至MQ服务；反之如果这笔消息上游服务处理失败，可靠消息服务则会进行消息删除。通过这样以上机制就确保了“<strong>上游服务本地事务成功处理+消息成功投递</strong>”处于一个原子操作了。</p>
<p><font color='red'>2、下游服务（用户余额系统）如何确保对MQ服务Topic消息的消费100%都能处理成功？</font></p>
<p>在1的过程中，确保了上游服务逻辑处理与MQ消息的投递具备原子性，那么当消息被成功投递到了MQ服务的指定Topic后，下游服务如何才能确保消息的消费一定能被成功处理呢？</p>
<p>在正常的流程中，下游服务等待消费Topic的消息并进行自身本地数据库事务的处理，如果<strong>处理成功则会主动通知可靠消息服务，可靠消息服务此时就会将消息的状态更新为“已完成”</strong>；反之，处理失败下游服务就无法再主动向可靠消息服务发送通知消息了。</p>
<p>此时，与消息投递过程中的异常逻辑一样，可靠消息服务也会启动相应的后台线程，轮询一直处于“<strong>已发送</strong>”状态的消息，判断状态持续时间是否超过了规定时间，如果超时，可靠消息服务就会再次向MQ服务投递此消息，从而确保消息能被再次消费处理。（注意，也可能出现下游服务处理成功，但是通知消息发送失败的情况，所以为了确保幂等，下游服务也需要在业务逻辑上做好相应的防重处理）。</p>
<h3 id="RocketMQ事务消息机制"><a href="#RocketMQ事务消息机制" class="headerlink" title="RocketMQ事务消息机制"></a>RocketMQ事务消息机制</h3><p>在👆面第2小节的内容中，我们演示了一个自编写的中间服务+MQ来实现事务消息的示例。但是在现实的工作场景中，开发和维护一套可靠消息服务是一件很耗费资源和成本的事情，实际上，RocketMQ的最新版本（4.3.0+）中已经实现了可靠消息服务的所有功能，并且在保证高并发、高可用、高性能方面做了更为优秀的架构实现。</p>
<p>从设计逻辑上看RocketMQ所支持的分布式事务特性与上节中阐述的可靠消息服务基本上是一致的。只是RocketMQ在实现上相比较于可靠消息服务而言做了更为复杂的设计，并且因为天然与MQ服务本身紧密结合，所以在高可用、可靠性、性能等方面直接继承了MQ服务本身的架构优势。</p>
<p>下面我们就结合流程并通过示例代码的分析来和大家一起理解下利用RocketMQ是如何实现分布式事务操作的？</p>
<p><img src="/images/java/distributed-transaction-3.png" alt="原理"></p>
<p>在应用场景中分布式服务通过MQ通信的过程中，发送消息的一方我们称之为<strong>Producer</strong>，接收消费消息的一方我们称之为<strong>Consumer</strong>。如果Producer自身业务逻辑本地事务执行成功与否希望和消息的发送保持一个原子性（也就是说如果Producer本地事务执行成功，那么这笔消息就一定要被成功的发送到RocketMQ服务的指定Topic，并且Consumer一定要被消费成功；反之，如果Producer本地事务执行失败，那么这笔消息就应该被RocketMQ服务器丢弃）的话，RocketMQ是怎么做的呢？</p>
<ol>
<li><p>Producer选择使用RockerMQ提供的事务消息方法向RocketMQ服务发送事务消息(设置消息属性<strong>TRAN_MSG=TRUE</strong>)；</p>
</li>
<li><p>RocketMQ服务端在收到消息后会判断消息的属性是否为事务消息，如果是普通消息就直接Push给Consumer；如果是事务消息就会对该消息进行特殊处理设置事务ID，并暂时设置该消息对Consumer不可见，之后向Producer返回Pre消息发送状态(<strong>SEND_OK</strong>)。</p>
</li>
<li><p>之后Producer就会开始执行本地事务逻辑，并设置本地事务处理状态后向RocketMQ服务器发送该事务消息的确认/回滚消息(<strong>COMMIT_MESSAGE／ROLLBACK_MESSAGE</strong>)。</p>
</li>
<li><p>RocketMQ服务器根据该笔事务消息的本地事务执行状态决定是否将消息Push给Consumer还是删除该消息。</p>
</li>
<li><p>之后Consumer就会消费该消息，执行Consumer的本地事务逻辑，如果执行成功则向RocketMQ返回“<strong>CONSUME_SUCCESS</strong>”；反之出现异常则需要返回“<strong>RECONSUME_LATER</strong>”，以便RocketMQ再次Push该消息，<strong>这一点在实际编程中需要控制好</strong>。</p>
</li>
</ol>
<h3 id="RocketMQ事务消息实现"><a href="#RocketMQ事务消息实现" class="headerlink" title="RocketMQ事务消息实现"></a>RocketMQ事务消息实现</h3><p>相信看到这里，大家对于RocketMQ的分布式事务消息的理解应该有了一个相对清晰的概念了，那么在代码中如何编写呢？</p>
<p>在开发中使用RocketMQ的分布式事务消息Consumer的代码不需要有什么特别的变化与普通消息Consumer代码一致就可以。</p>
<p>Consumer示例代码：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">public</span> static <span class="type">void</span> main(String[] args) throws InterruptedException, MQClientException &#123;</span><br><span class="line"> </span><br><span class="line">    // Instantiate <span class="keyword">with</span> specified consumer <span class="keyword">group</span> <span class="type">name</span>.</span><br><span class="line">    DefaultMQPushConsumer consumer = <span class="built_in">new</span> DefaultMQPushConsumer("CID_PAY_ACCOUNT");</span><br><span class="line"></span><br><span class="line">    // Specify <span class="type">name</span> <span class="keyword">server</span> addresses.</span><br><span class="line">    consumer.setNamesrvAddr("10.211.55.4:9876;10.211.55.5:9876;10.211.55.6:9876");</span><br><span class="line"></span><br><span class="line">    // Subscribe one more more topics <span class="keyword">to</span> consume.</span><br><span class="line">    consumer.subscribe("PAY_ACCOUNT", "*");</span><br><span class="line">    // Register callback <span class="keyword">to</span> <span class="keyword">execute</span> <span class="keyword">on</span> arrival <span class="keyword">of</span> messages fetched <span class="keyword">from</span> brokers.</span><br><span class="line">    consumer.registerMessageListener(<span class="built_in">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        <span class="built_in">public</span> ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs,</span><br><span class="line">            ConsumeConcurrentlyContext context) &#123;</span><br><span class="line">            <span class="keyword">for</span> (MessageExt messageExt : msgs) &#123;</span><br><span class="line">                <span class="keyword">System</span>.<span class="keyword">out</span>.println(<span class="built_in">new</span> String(messageExt.getBody()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    //Launch the consumer instance.</span><br><span class="line">    consumer.<span class="keyword">start</span>();</span><br><span class="line">    <span class="keyword">System</span>.<span class="keyword">out</span>.printf("Consumer Started.%n");</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要的改变是在Producer代码，我们需要额外编写一个实现执行本地事务逻辑，以及检查本地事务状态的类。示例代码如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="symbol">TransactionListenerImpl</span> <span class="symbol">implements</span> <span class="symbol">TransactionListener</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> AtomicInteger transactionIndex = new AtomicInteger(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> ConcurrentHashMap&lt;String, Integer&gt; localTrans = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> LocalTransactionState executeLocalTransaction(Message msg, Object arg) &#123;</span><br><span class="line">        <span class="built_in">int</span> value = transactionIndex.getAndIncrement();</span><br><span class="line">        <span class="built_in">int</span> status = value % <span class="number">3</span>;</span><br><span class="line">        localTrans.put(msg.getTransactionId(), status);</span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> LocalTransactionState checkLocalTransaction(MessageExt msg) &#123;</span><br><span class="line">        Integer status = localTrans.<span class="keyword">get</span>(msg.getTransactionId());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != status) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Producer示例代码：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> TransactionProducerTest &#123;</span><br><span class="line">    public static void main(String<span class="literal">[]</span> args) throws MQClientException, InterruptedException &#123;</span><br><span class="line">        TransactionListener transactionListener = <span class="keyword">new</span> <span class="constructor">TransactionListenerImpl()</span>;</span><br><span class="line">        TransactionMQProducer producer = <span class="keyword">new</span> <span class="constructor">TransactionMQProducer(<span class="string">"CID_PAY_ACCOUNT"</span>)</span>;</span><br><span class="line">        producer.set<span class="constructor">NamesrvAddr(<span class="string">"10.211.55.4:9876;10.211.55.5:9876;10.211.55.6:9876"</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        ExecutorService executorService = <span class="keyword">new</span> <span class="constructor">ThreadPoolExecutor(2, 5, 100, TimeUnit.SECONDS, <span class="params">new</span> ArrayBlockingQueue&lt;Runnable&gt;(2000)</span>, <span class="keyword">new</span> <span class="constructor">ThreadFactory()</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Thread <span class="keyword">new</span><span class="constructor">Thread(Runnable <span class="params">r</span>)</span> &#123;</span><br><span class="line">                Thread thread = <span class="keyword">new</span> <span class="constructor">Thread(<span class="params">r</span>)</span>;</span><br><span class="line">                thread.set<span class="constructor">Name(<span class="string">"client-transaction-msg-check-thread"</span>)</span>;</span><br><span class="line">                return thread;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        producer.set<span class="constructor">ExecutorService(<span class="params">executorService</span>)</span>;</span><br><span class="line">        producer.set<span class="constructor">TransactionListener(<span class="params">transactionListener</span>)</span>;</span><br><span class="line">        producer.start<span class="literal">()</span>;</span><br><span class="line"> </span><br><span class="line">        String<span class="literal">[]</span> tags = <span class="keyword">new</span> String<span class="literal">[]</span> &#123;<span class="string">"TagA"</span>, <span class="string">"TagB"</span>, <span class="string">"TagC"</span>, <span class="string">"TagD"</span>, <span class="string">"TagE"</span>&#125;;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, String&gt; paramMap = <span class="keyword">new</span> HashMap&lt;&gt;<span class="literal">()</span>;</span><br><span class="line">            paramMap.put(<span class="string">"type"</span>, <span class="string">"6"</span>);</span><br><span class="line">            paramMap.put(<span class="string">"bizOrderId"</span>, <span class="string">"15414012438257823"</span>);</span><br><span class="line">            paramMap.put(<span class="string">"payOrderId"</span>, <span class="string">"15414012438257823"</span>);</span><br><span class="line">            paramMap.put(<span class="string">"amount"</span>, <span class="string">"10"</span>);</span><br><span class="line">            paramMap.put(<span class="string">"userId"</span>, <span class="string">"200001"</span>);</span><br><span class="line">            paramMap.put(<span class="string">"tradeType"</span>, <span class="string">"charge"</span>);</span><br><span class="line">            paramMap.put(<span class="string">"financeStatus"</span>, <span class="string">"0"</span>);<span class="comment">//财务状态，应收</span></span><br><span class="line">            paramMap.put(<span class="string">"channel"</span>, <span class="string">"a"</span>);<span class="comment">//余额</span></span><br><span class="line">            paramMap.put(<span class="string">"tradeTime"</span>, <span class="string">"20190101202022"</span>);</span><br><span class="line">            paramMap.put(<span class="string">"nonce_str"</span>, <span class="string">"xkdkskskdksk"</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//拼凑消息体</span></span><br><span class="line">            Message msg = <span class="keyword">new</span> <span class="constructor">Message(<span class="string">"PAY_ACCOUNT"</span>, <span class="string">"pre"</span>,<span class="params">paramMap</span>.<span class="params">toString</span>()</span>.get<span class="constructor">Bytes(RemotingHelper.DEFAULT_CHARSET)</span>);</span><br><span class="line">            SendResult sendResult = producer.send<span class="constructor">MessageInTransaction(<span class="params">msg</span>, <span class="params">null</span>)</span>;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.printf(<span class="string">"%s%n"</span>, sendResult);</span><br><span class="line"> </span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>sleep(<span class="number">10</span>);</span><br><span class="line">        &#125; catch (MQClientException <span class="pattern-match">| <span class="constructor">UnsupportedEncodingException</span> e) &#123;</span></span><br><span class="line"><span class="pattern-match">            e.print<span class="constructor">StackTrace()</span>;</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match"> </span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">Thread</span>.sleep(10<span class="operator">*</span>1000);</span></span><br><span class="line"><span class="pattern-match">        producer.shutdown();</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>

<p>与非事务消息直接调用RocketMQ Client的send方法不同，事务消息发送需要设置事务监听器类，并调用sendMessageInTransaction方法，而这个方法的具体逻辑也就是上述流程中描述的那样，具体大家可以看下。</p>
<h3 id="场景说明"><a href="#场景说明" class="headerlink" title="场景说明"></a>场景说明</h3><p>目前RocketMQ消息中间件的使用场景比较广泛，对于需要通过MQ进行异步解耦的分布式应用系统来说，RocketMQ无疑是一个不错的技术选择。接下来，我们就以<strong>对数据一致性要求非常高</strong>的分布式支付系统为例，来看看基于RocketMQ的事务消息适用于哪些特定场景，从而实现支付系统数据的高度一致性。</p>
<p>事实上，<strong>支付系统的数据一致性是一个复杂的问题</strong>，原因在于支付流程的各个环节都存在异步的不确定性，例如支付系统需要跟第三方渠道进行交互，不同的支付渠道交互流程存在差异，并且有异步支付结果回调的情况。</p>
<p>除此以外，支付系统内部本身又是由多个不同子系统组成，除核心支付系统外，还有账务系统、商户通知系统等等，而核心支付系统本身也会被拆分为多个不同的服务模块，如风控、路由等用以实现不同的功能逻辑。<strong>某些场景我们无法通过分布式事务来实现数据一致性，只能通过额外的业务补偿手段</strong>，如二次轮训、支付对账等来实现数据最终一致性。</p>
<p>综上所述，<strong>支付系统是一个复杂的系统，要完全实现数据的一致性单靠某一种手段是无法实现的</strong>，大部分情况下我们可以通过额外的业务补偿逻辑来实现数据最终一致性，只是这样补偿逻辑需要以更多的业务开发逻辑为代价，并且在时效性上会存在延迟的问题。</p>
<p>举个例子，支付核心系统支付成功后会更新自己的订单状态为支付成功，整个核心交易流程是一个比较实时同步的场景，如果出现数据不一致，<strong>会有额外的补偿逻辑如二次支付订单状态轮询、T+1日对账等用以确保支付状态数据的最终一致性</strong>。但是除了核心支付外，支付成功的结果是需要通知到支付账务系统、以及业务端系统，而为了确保性能，一般后续的通知就不会与主流程一样设计成实时同步，而是通过MQ异步解耦发送消息给独立的“通知响应模块”，而“<strong>通知响应模块</strong>”此时就可以通过分布式事务消息来与支付账户系统、业务端等系统实现数据一致性，从而<strong>减少需要补偿手段处理的范围，提高系统的数据一致性等级和灵敏度</strong>。</p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=https://github.com/farawayliu&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>far</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/05/20/java/分布式事务之实现分布式系统的最终一致性/">https://www.ofcoder.com/2020/05/20/java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8B%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 并发笔记 - ofcoder.com. Author by far.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.ofcoder.com/2020/05/20/java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B9%8B%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7/" data-id="cl7wxhx6f000tlcj101f544hf" data-qrcode="data:image/png;base64,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">分享</a><div class="tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">分布式事务</a><a href="/tags/RocketMQ/">RocketMQ</a><a href="/tags/%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7/">最终一致性</a></div><div class="post-nav"><a class="pre" href="/2020/07/05/theory/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE%20-%202PC,%203PC/">分布式一致性协议 - 2PC, 3PC</a><a class="next" href="/2020/03/14/java/maven%E4%BE%9D%E8%B5%96%E6%9C%AC%E5%9C%B0jar%E5%8C%85/">maven依赖本地jar包</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'s8pJruGkXvi5Skd0e6EaMQ5X-gzGzoHsz',
  appKey:'K3NjnXxqhPNwUw5pmqOzoO4i',
  placeholder:'说出你的故事...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#导读"><span class="toc-number">1.</span> <span class="toc-text">导读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务消息原理"><span class="toc-number">2.</span> <span class="toc-text">事务消息原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQ事务消息机制"><span class="toc-number">3.</span> <span class="toc-text">RocketMQ事务消息机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQ事务消息实现"><span class="toc-number">4.</span> <span class="toc-text">RocketMQ事务消息实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#场景说明"><span class="toc-number">5.</span> <span class="toc-text">场景说明</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">并发笔记 - ofcoder.com | </a><a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">粤ICP备18053760号</a><div>本站访客 <span id="busuanzi_value_site_uv"></span>人次 | 总访问 <span id="busuanzi_value_site_pv"></span>次<img src="https://s04.flagcounter.com/count/MnzJ/bg_FFFFFF/txt_000000/border_726EE0/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" style="display: none;"/></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>