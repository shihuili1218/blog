<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>谈谈mybatis、dubbo基础原理 | 并发笔记 - ofcoder.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><!-- 顶部加载进度条 --><script type="text/javascript" src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">谈谈mybatis、dubbo基础原理</h1><a id="logo" href="/.">并发笔记 - ofcoder.com</a><p class="description">一位后端开发的养肝历程，护发经验</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/usql/"><i class="fa fa-database"> usql</i></a><a href="/book/"><i class="fa fas fa-book"> book</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">谈谈mybatis、dubbo基础原理</h1><div class="post-meta">Apr 9, 2019<span> | </span><span class="category"><a href="/categories/java/">java</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.7k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 7</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2019/04/09/java/%E8%B0%88%E8%B0%88mybatis%E3%80%81dubbo%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/#vcomment"><span class="valine-comment-count" data-xid="/2019/04/09/java/%E8%B0%88%E8%B0%88mybatis%E3%80%81dubbo%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/"></span><span> 条评论</span></a><div class="post-content"><p>本章只介绍简单的原理，思路如下，先谈谈动态代理，以熟悉的mybatis举例，如何做到注入mapper的，引申到dubbo。。</p>
<h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><p><strong>本节知识点陈旧，可以跳过</strong>。先回顾一下什么是代理，代理模式是指给某一个对象提供一个代理对象，并由代理对象控制对原对象的引用。这种模式有什么用呢？它可以在原对象的基础上增强原对象的功能，比如在原对象调用一个方法的前后进行日志、事务操作等。Spring AOP就使用了代理模式。<br>代理分静态代理、动态代理。下面分别使用两种方式代理以下接口<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>People &#123;</span><br><span class="line">    void say();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h4><p>静态代理是指我们设计模式中用到的那样，新建一个代理类，把要代理对象的传入到这个类中，手动调用这个代理类的方法。稍微感受一下。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleProxy</span> <span class="keyword">implements</span> <span class="title">People</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> People <span class="keyword">target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PeopleProxy</span><span class="params">(People <span class="keyword">target</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">target</span> = <span class="keyword">target</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Do something before call"</span>);</span><br><span class="line">        <span class="keyword">target</span>.say();</span><br><span class="line">        System.out.println(<span class="string">"Do something after call"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h4><p>动态代理主要分为JDK动态代理和cglib动态代理两大类，本文主要对JDK动态代理进行探讨。<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T getProxyObj(<span class="class"><span class="keyword">Class</span> <span class="title">clazz</span>) &#123;</span></span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(getClass().getClassLoader(), <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>[]&#123;<span class="title">clazz</span>&#125;, <span class="title">this</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object invoke(Object proxy, <span class="function"><span class="keyword">Method</span> <span class="title">method</span>, <span class="title">Object</span>[] <span class="title">args</span>) <span class="title">throws</span> <span class="title">Throwable</span> &#123;</span></span><br><span class="line">        System.out.println(<span class="string">"proxy the method: "</span> + <span class="function"><span class="keyword">method</span>.<span class="title">getDeclaringClass</span>(</span>).getName() + <span class="string">"."</span> + <span class="function"><span class="keyword">method</span>.<span class="title">getName</span>(</span>) + <span class="string">"();"</span>);</span><br><span class="line">        // do something.</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> &#123;</span></span><br><span class="line">    <span class="keyword">public</span> static void main(String[] args) &#123;</span><br><span class="line">        ProxyFactory proxyFactory = <span class="keyword">new</span> ProxyFactory();</span><br><span class="line">        People proxyObj = proxyFactory.getProxyObj(People<span class="class">.<span class="keyword">class</span>);</span></span><br><span class="line">        proxyObj.say();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>以上代码正确执行并输出<code>proxy the method:xxx;</code>，代码中没有写任何People的实现类，更不要说People的实例了，却能调用到say()方法。</p>
<p>总结一下，动态代理可以帮我们根据接口生成对应的接口的代理对象，而在这个代理对象执行时，我们还可以做一些增强处理。</p>
<h3 id="mybatis原理"><a href="#mybatis原理" class="headerlink" title="mybatis原理"></a>mybatis原理</h3><p>上面了解回顾动态代理实现和作用。是不是马上想到了，和我们在mybatis中写Mapper类很像。那么接下来我们寻找mybatis源码，一起验证上面的猜想。</p>
<p>在日常开发中，我们都或多或少了解到，mybatis为了代替手工使用 SqlSessionDaoSupport 或 SqlSessionTemplate 编写数据访问对象(DAO)的代码，MyBatis-Spring 提供了一个动态代理的实现MapperFactoryBean。那么我们从这下手一定可以找到怎么生成代理对象的，并且在代理对象中怎么执行sql的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperFactoryBean</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> addToConfig = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//intentionally empty </span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperFactoryBean</span><span class="params">(Class&lt;T&gt; mapperInterface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getSqlSession().getMapper(<span class="keyword">this</span>.mapperInterface);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码为MapperFactoryBean部分源码，它提供一个构造方法传入接口的Class对象，在getObject()方法中返回这个接口的代理对象，那么我们着重看getMapper()方法，一直往下，我们会找到调用MapperRegistry.getMapper()方法。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> MapperRegistry &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> final Configuration config;</span><br><span class="line">  <span class="keyword">private</span> final Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt;<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">  @<span class="constructor">SuppressWarnings(<span class="string">"unchecked"</span>)</span></span><br><span class="line">  public &lt;T&gt; T get<span class="constructor">Mapper(Class&lt;T&gt; <span class="params">type</span>, SqlSession <span class="params">sqlSession</span>)</span> &#123;</span><br><span class="line">    final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(<span class="keyword">type</span>);</span><br><span class="line">    <span class="keyword">if</span> (mapperProxyFactory<span class="operator"> == </span>null) &#123;</span><br><span class="line">      throw <span class="keyword">new</span> <span class="constructor">BindingException(<span class="string">"Type "</span> + <span class="params">type</span> + <span class="string">" is not known to the MapperRegistry."</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      return mapperProxyFactory.<span class="keyword">new</span><span class="constructor">Instance(<span class="params">sqlSession</span>)</span>;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw <span class="keyword">new</span> <span class="constructor">BindingException(<span class="string">"Error getting mapper instance. Cause: "</span> + <span class="params">e</span>, <span class="params">e</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> MapperProxyFactory&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">  @<span class="constructor">SuppressWarnings(<span class="string">"unchecked"</span>)</span></span><br><span class="line">  protected T <span class="keyword">new</span><span class="constructor">Instance(MapperProxy&lt;T&gt; <span class="params">mapperProxy</span>)</span> &#123;</span><br><span class="line">    return (T) <span class="module-access"><span class="module"><span class="identifier">Proxy</span>.</span></span><span class="keyword">new</span><span class="constructor">ProxyInstance(<span class="params">mapperInterface</span>.<span class="params">getClassLoader</span>()</span>, <span class="keyword">new</span> Class<span class="literal">[]</span> &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>走到这里，进入到mapperProxyFactory.newInstance();方法中，就会看到我们开章举例的动态代理代码。</p>
<p>至此，生成代理对象的过程到此结束，这里解释了为什么我们使用mybatis，只写一个对应的接口，为什么spring能注入这个接口的对象。</p>
<p>那么剩下的问题就是，怎么执行对应sql语句的。知道了mybatis通过动态代理生成代理对象的，那么我们推测应该是通过实现InvocationHandler接口的invoke方法中来统一执行sql的。那么接下来我们找到一个目标MapperProxy</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> static <span class="keyword">final</span> long serialVersionUID = -<span class="number">6424540398559729838</span>L;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">Class</span>&lt;<span class="title">T</span>&gt; <span class="title">mapperInterface</span>;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;<span class="function"><span class="keyword">Method</span>, <span class="title">MapperMethod</span>&gt; <span class="title">methodCache</span>;</span></span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  <span class="keyword">public</span> Object invoke(Object proxy, <span class="function"><span class="keyword">Method</span> <span class="title">method</span>, <span class="title">Object</span>[] <span class="title">args</span>) <span class="title">throws</span> <span class="title">Throwable</span> &#123;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) &#123;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">method</span>.<span class="title">invoke</span>(</span>this, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDefaultMethod(<span class="function"><span class="keyword">method</span>)) &#123;</span></span><br><span class="line">        <span class="keyword">return</span> invokeDefaultMethod(proxy, <span class="function"><span class="keyword">method</span>, <span class="title">args</span>);</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> MapperMethod cachedMapperMethod(<span class="function"><span class="keyword">Method</span> <span class="title">method</span>) &#123;</span></span><br><span class="line">    MapperMethod mapperMethod = methodCache.get(<span class="function"><span class="keyword">method</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (mapperMethod == <span class="literal">null</span>) &#123;</span><br><span class="line">      mapperMethod = <span class="keyword">new</span> MapperMethod(mapperInterface, <span class="function"><span class="keyword">method</span>, <span class="title">sqlSession</span>.<span class="title">getConfiguration</span>(</span>));</span><br><span class="line">      methodCache.put(<span class="function"><span class="keyword">method</span>, <span class="title">mapperMethod</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mapperMethod;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到invoke方法。由于mapper是一个代理对象，那么它就会运行到invoke方法里面，invoke首先判断是否一个类，显然这里mapper是一个接口，不是类所以判定失败。那么跟着就会生成MapperMethod对象，它是通过cachedMapperMethod方法对其初始化的，然后执行execute方法，把sqlSession和当前运行的参数传递进去。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> MapperMethod &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> final SqlCommand command;</span><br><span class="line">  <span class="keyword">private</span> final MethodSignature <span class="keyword">method</span>;</span><br><span class="line"></span><br><span class="line">  public <span class="constructor">MapperMethod(Class&lt;?&gt; <span class="params">mapperInterface</span>, Method <span class="params">method</span>, Configuration <span class="params">config</span>)</span> &#123;</span><br><span class="line">    this.command = <span class="keyword">new</span> <span class="constructor">SqlCommand(<span class="params">config</span>, <span class="params">mapperInterface</span>, <span class="params">method</span>)</span>;</span><br><span class="line">    this.<span class="keyword">method</span> = <span class="keyword">new</span> <span class="constructor">MethodSignature(<span class="params">config</span>, <span class="params">mapperInterface</span>, <span class="params">method</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Object execute(SqlSession sqlSession, Object<span class="literal">[]</span> args) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    switch (command.get<span class="constructor">Type()</span>) &#123;</span><br><span class="line">      case INSERT: &#123;</span><br><span class="line">      Object param = <span class="keyword">method</span>.convert<span class="constructor">ArgsToSqlCommandParam(<span class="params">args</span>)</span>;</span><br><span class="line">        result = row<span class="constructor">CountResult(<span class="params">sqlSession</span>.<span class="params">insert</span>(<span class="params">command</span>.<span class="params">getName</span>()</span>, param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case UPDATE: &#123;</span><br><span class="line">        Object param = <span class="keyword">method</span>.convert<span class="constructor">ArgsToSqlCommandParam(<span class="params">args</span>)</span>;</span><br><span class="line">        result = row<span class="constructor">CountResult(<span class="params">sqlSession</span>.<span class="params">update</span>(<span class="params">command</span>.<span class="params">getName</span>()</span>, param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case DELETE: &#123;</span><br><span class="line">        Object param = <span class="keyword">method</span>.convert<span class="constructor">ArgsToSqlCommandParam(<span class="params">args</span>)</span>;</span><br><span class="line">        result = row<span class="constructor">CountResult(<span class="params">sqlSession</span>.<span class="params">delete</span>(<span class="params">command</span>.<span class="params">getName</span>()</span>, param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case SELECT:</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">method</span>.returns<span class="constructor">Void()</span><span class="operator"> &amp;&amp; </span><span class="keyword">method</span>.has<span class="constructor">ResultHandler()</span>) &#123;</span><br><span class="line">          execute<span class="constructor">WithResultHandler(<span class="params">sqlSession</span>, <span class="params">args</span>)</span>;</span><br><span class="line">          result = null;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">method</span>.returns<span class="constructor">Many()</span>) &#123;</span><br><span class="line">          result = execute<span class="constructor">ForMany(<span class="params">sqlSession</span>, <span class="params">args</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">method</span>.returns<span class="constructor">Map()</span>) &#123;</span><br><span class="line">          result = execute<span class="constructor">ForMap(<span class="params">sqlSession</span>, <span class="params">args</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">method</span>.returns<span class="constructor">Cursor()</span>) &#123;</span><br><span class="line">          result = execute<span class="constructor">ForCursor(<span class="params">sqlSession</span>, <span class="params">args</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Object param = <span class="keyword">method</span>.convert<span class="constructor">ArgsToSqlCommandParam(<span class="params">args</span>)</span>;</span><br><span class="line">          result = sqlSession.select<span class="constructor">One(<span class="params">command</span>.<span class="params">getName</span>()</span>, param);</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">      case FLUSH:</span><br><span class="line">        result = sqlSession.flush<span class="constructor">Statements()</span>;</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        throw <span class="keyword">new</span> <span class="constructor">BindingException(<span class="string">"Unknown execution method for: "</span> + <span class="params">command</span>.<span class="params">getName</span>()</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result<span class="operator"> == </span>null<span class="operator"> &amp;&amp; </span><span class="keyword">method</span>.get<span class="constructor">ReturnType()</span>.is<span class="constructor">Primitive()</span><span class="operator"> &amp;&amp; </span>!<span class="keyword">method</span>.returns<span class="constructor">Void()</span>) &#123;</span><br><span class="line">      throw <span class="keyword">new</span> <span class="constructor">BindingException(<span class="string">"Mapper method '"</span> + <span class="params">command</span>.<span class="params">getName</span>()</span> </span><br><span class="line">          + <span class="string">" attempted to return null from a method with a primitive return type ("</span> + <span class="keyword">method</span>.get<span class="constructor">ReturnType()</span> + <span class="string">")."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，mybatis原理，真相大白。在execute方法中，判断需要执行的sql是insert、update、select，做对应的处理，通过sqlSession执行对应的sql语句。</p>
<p>这也就解释了为什么xml中的命名空间要和接口全名对应，sql的id要和方法名对应。因为mybatis是在这里通过类名+方法名，定位到某一条sql的。</p>
<h3 id="dubbo基础原理"><a href="#dubbo基础原理" class="headerlink" title="dubbo基础原理"></a>dubbo基础原理</h3><p>本节本来想借助上面mybatis的原理，我们写一个类似dubbo的rpc框架，但是篇幅内容过长，解释不清，下一次我们一起写一个rpc了解dubbo执行原理。<a href="https://www.ofcoder.com/2019/06/26/java/%E6%89%8B%E5%86%99dubbo%201-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">点击查看 - 手写dubbo</a></p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=https://github.com/farawayliu&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>far</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/04/09/java/谈谈mybatis、dubbo基础原理/">https://www.ofcoder.com/2019/04/09/java/%E8%B0%88%E8%B0%88mybatis%E3%80%81dubbo%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 2021 ofcoder. Author by far.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.ofcoder.com/2019/04/09/java/%E8%B0%88%E8%B0%88mybatis%E3%80%81dubbo%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/" data-id="ckxm1vibx001ef8j1g018hcox" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQ4AAAEOCAAAAABd2qZ5AAAD+klEQVR42u3aS47iQBAFwL7/pXu2I7VcvJdZ0DNSeIXAuMphpCQ/X1/x8f1wPH369/s/X5/f+fl+vp/zitcOHDhw4MBx6dL5rZ5v8un8hOy88/OK53vEgQMHDhx3Oc6bSziKJcsrzPY2ewA4cODAgeO3OJI0rA3GyXXOO8w/xYEDBw4c/zLHcOFRva5N8HDgwIEDx29xtC2c8wJJA+l8ZvLprLh5rVaKAwcOHDjSaYEiaP0vr98y34EDBw4cOIJQlx9JitWuvgnJF+4IBw4cOHBcCg6bhC3/NCfLA+cZYjg2gQMHDhw41hybjOZ8Zj6y0JYLZwSrNA8HDhw4cAQc7SXygLoZiWgfRpvOPa6LAwcOHDjewPHJsYC82JcE7Pb8x8kOHDhw4MCx4EgC26z9M3u/LUpuAvOLx4kDBw4cOEb3kiQ2ecNpn1YlJb/ZisX/Dhw4cODAseCYBdrZyMIs/Ztds31Uq/8dOHDgwIHjR84yC71Je2nTOprdWB6qH1M4HDhw4MCx5mjTtk25MB9xyL+Vj1/U9VEcOHDgwDHiaF+3QwztwEEe+PNgHIV8HDhw4MCx5mi3uCdLNpR8d0NTPD0cOHDgwFFy3Nr6OwbgWu4kIXzxGgcOHDhwrDn2idlmc/n1N+fUURUHDhw4cCw42kCbbCXHzVtW7cDELCTjwIEDB45bHPkYwexbs1JjO7iQlwgfHxIOHDhw4Fhz5Mvn5bx90yjHnQXa6DeCAwcOHDgWHG2hLW9BDScsjiH81io4cODAgeMdHHkJLy/MzVKvNqzuW1Mv+m84cODAgWPEMSsC3hpQ2w8xbHb+GHRx4MCBA8eaIzn1VjOpTQJz+nZ84QUTDhw4cOAYcdTpTdkQ2hT7PlOyjDJaHDhw4MCx4MiLfXmIzUNmcpNJoG2vgAMHDhw4bnFcaNJcGlnIN50/qrwoiQMHDhw47nK0AwdtEL1bTLzVZHo8EwcOHDhwLDg2Sdds620S2F55EzFx4MCBA8e7Odqgm9/MLKjnqV27h69ZlMaBAwcOHA8cs8G1Nn3KS4GbBlL+eF7ksjhw4MCBY8Gxb0G1QXEWqtuRi3b/OHDgwIFjz1EEoXi4IU8C80GHfIRitqviV4ADBw4cOI538V0es7G2c1J3awAiSRSL3wUOHDhw4Jhf/2sWljajBpumV1tkvPunAQcOHDhw7DOX9vY2baR3DMC1oxg4cODAgeMWRxIIkyA3o5zd8OZ4vA4OHDhw4PggRzt2sEffN6LqFXHgwIEDxwc58jZSO9aQtLLa9tiwGooDBw4cOC5x5A2ePLzNkrd8NCE5sy0d4sCBAweOPcd+o23zaRa287Ca73P22HDgwIEDx8OnfwDpp6/yWGMYDgAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/%E5%B9%B2%E8%B4%A7/">干货</a><a href="/tags/dubbo/">dubbo</a><a href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">动态代理</a><a href="/tags/mybatis/">mybatis</a></div><div class="post-nav"><a class="pre" href="/2019/04/21/java/%E8%B0%88%E8%B0%88%E5%88%86%E8%A1%A8%E5%88%86%E5%BA%93%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">谈谈分表分库常见问题解决方案</a><a class="next" href="/2019/04/01/theory/%E8%B0%88%E8%B0%88mysql%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0-B+Tree/">谈谈mysql索引实现-B+ Tree</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'s8pJruGkXvi5Skd0e6EaMQ5X-gzGzoHsz',
  appKey:'K3NjnXxqhPNwUw5pmqOzoO4i',
  placeholder:'说出你的故事...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#代理模式"><span class="toc-number">1.</span> <span class="toc-text">代理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#静态代理"><span class="toc-number">1.1.</span> <span class="toc-text">静态代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态代理"><span class="toc-number">1.2.</span> <span class="toc-text">动态代理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mybatis原理"><span class="toc-number">2.</span> <span class="toc-text">mybatis原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dubbo基础原理"><span class="toc-number">3.</span> <span class="toc-text">dubbo基础原理</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">并发笔记 - ofcoder.com | </a><a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">粤ICP备18053760号</a><div>本站访客 <span id="busuanzi_value_site_uv"></span>人次 | 总访问 <span id="busuanzi_value_site_pv"></span>次<img src="https://s04.flagcounter.com/count/MnzJ/bg_FFFFFF/txt_000000/border_726EE0/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" style="display: none;"/></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.7" zIndex="-1" count="5" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>