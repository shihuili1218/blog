<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>谈谈分表分库常见问题解决方案 | 并发笔记 - ofcoder.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><!-- 顶部加载进度条 --><script type="text/javascript" src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">谈谈分表分库常见问题解决方案</h1><a id="logo" href="/.">并发笔记 - ofcoder.com</a><p class="description">一位后端开发的养肝历程，护发经验</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/usql/"><i class="fa fa-database"> usql</i></a><a href="/book/"><i class="fa fas fa-book"> book</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">谈谈分表分库常见问题解决方案</h1><div class="post-meta">Apr 21, 2019<span> | </span><span class="category"><a href="/categories/java/">java</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 6</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2019/04/21/java/%E8%B0%88%E8%B0%88%E5%88%86%E8%A1%A8%E5%88%86%E5%BA%93%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/#vcomment"><span class="valine-comment-count" data-xid="/2019/04/21/java/%E8%B0%88%E8%B0%88%E5%88%86%E8%A1%A8%E5%88%86%E5%BA%93%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"></span><span> 条评论</span></a><div class="post-content"><p>本章的思路，是先讲讲根据业务增长进行分表分库，以及实现方案探讨，对这些方案产生的一系列问题该如何解决，以及现在社区中活跃的第三方分表分库中间件。</p>
<h3 id="分表分库案例"><a href="#分表分库案例" class="headerlink" title="分表分库案例"></a>分表分库案例</h3><p>互联网时代，每天都会产生海量的数据。我觉得每一位程序员都应该或多或少的了解到存储这个数据的解决办法，特别是小公司的程序员更应自己多尝试，多实践。因为在小公司，我们没有优秀的架构师，没有前辈的指引，更没有性能良好的设备来支持大数据计算。那么遇到数据到达瓶颈了怎么办？难道让业务不发展了？公司不挣钱了？所以特别是小公司的人更应该考虑。这是我个人的观点。</p>
<p><strong>为什么不适用nosql/newsql？</strong>目前绝大部分公司的核心数据都是：以RDBMS存储为主，NoSQL/NewSQL存储为辅！互联网公司又以MySQL为主，国企&amp;银行等不差钱的企业以Oracle/DB2为主！NoSQL/NewSQL宣传的无论多牛逼，就现在各大公司对它的定位，都是RDBMS的补充，而不是取而代之！</p>
<h3 id="常用解决方案"><a href="#常用解决方案" class="headerlink" title="常用解决方案"></a>常用解决方案</h3><p>常用分表分库的方案有很多</p>
<ol>
<li>你可以自己实现物理的分库分表</li>
<li>常用数据库，如mysql有自己分表的解决方案，如：partitions</li>
<li>使用第三方中间件</li>
</ol>
<p>这一节讲的就是自己实现物理分库分表，在分表之前，首先需要选择适当的分表策略，使得数据能够较为均衡地分不到多张表中，并且不影响正常的查询！</p>
<h4 id="分表"><a href="#分表" class="headerlink" title="分表"></a>分表</h4><p>对于互联网企业来说，大部分数据都是与用户关联的，因此，用户id是最常用的分表字段。因为大部分查询都需要带上用户id，这样既不影响查询，又能够使数据较为均衡地分布到各个表中(当然，有的场景也可能会出现冷热数据分布不均衡的情况)，如下图：<br><img src="/images/java/partition/partition_1.png" alt="逻辑图"></p>
<p>假设有一张表记录用户购买信息的日志表，由于日志记录条数太多，将被拆分成256张表。</p>
<p>拆分的记录根据user_id%256取得对应的表进行存储，前台应用则根据对应的user_id%256，找到对应日志存储的表进行访问。假如表结构如下</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">create</span> <span class="meta">table</span> order_log_(</span><br><span class="line">	order_id bi<span class="meta">gint(</span>20) <span class="meta">primary</span> <span class="meta">key</span> auto_increment,</span><br><span class="line">	user_id bi<span class="meta">gint(</span>20),</span><br><span class="line">	user_nick varchar(50)</span><br><span class="line">	....</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>那么要查询用户id为257的日志，就先算法hash值（257 % 256 = 1），确定到那一张表再查询.</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> order_log_1 <span class="keyword">where</span> user_id = <span class="number">257</span>;</span><br></pre></td></tr></table></figure>

<h4 id="分库"><a href="#分库" class="headerlink" title="分库"></a>分库</h4><p>对于分表来说，每张表的数据量是变小了，但是它们依然处于同一个数据库实例下，对于单个实例来说，吞吐量也是有限的。那么分库，你可以将多个schema部署在多个数据库实例上。如此的话，你需要在项目中配置多数据源，用来访问每个数据库实例，或者你也可以通过一个统一的微服务来做分表分库的路由。</p>
<p>与分表策略相似，分库可以采用通过一个关键字取模的方式，来对数据访问进行路由，如下图所示：<br><img src="/images/java/partition/partition_2.png" alt="逻辑图"></p>
<h4 id="分表分库"><a href="#分表分库" class="headerlink" title="分表分库"></a>分表分库</h4><p>有时数据库可能既面临着高并发访问的压力，又需要面对海量数据的存储问题，这时需要对数据库既采用分表策略，又采用分库策略，以便同时扩展系统的并发处理能力，以及提升单表的查询性能，这就是所谓的分库分表。那么这提供的一种策略就是：</p>
<ol>
<li>中间变量 = user_id % (分库数量 * 每个库的表数量)</li>
<li>库 = 取整数 (中间变量 / 每个库的表数量)</li>
<li>表 = 中间变量 % 每个库的表数量</li>
</ol>
<p>同样采用user_id作为路由字段，首先使用user_id 对库数量*每个库表的数量取模，得到一个中间变量；然后使用中间变量除以每个库表的数量，取整，便得到对应的库；而中间变量对每个库表的数量取模，即得到对应的表。</p>
<p>假设将原来的单库单表order拆分成256个库，每个库包含1024个表，那么按照前面所提到的路由策略，对于user_id=262145 的访问，路由的计算过程如下：</p>
<ol>
<li>中间变量 = 262145 % (256 * 1024) = 1</li>
<li>库 = 取整 (1/1024) = 0</li>
<li>表 = 1 % 1024 = 1</li>
</ol>
<p>这就意味着，对于user_id=262145 的订单记录的查询和修改，将被路由到第0个库的第1个order_1表中执行！</p>
<h3 id="副作用解决方案"><a href="#副作用解决方案" class="headerlink" title="副作用解决方案"></a>副作用解决方案</h3><p>分库分表的好处显而易见，解决了数据存储容量的问题，但也带来了诸多弊端。这里简单的来分析，以及怎么解决</p>
<p><strong>1. 如何能做到数据的平均拆分，防止某一库压力过大？</strong><br>系统开发者要结合业务特点来确定分库分表键，比如以userID为分库分表键，采用hash取模的方式将数据散列到不同的库中。<br>但并不是所有场景都适合用userID作为分库分表键的，若存在“大卖家”，则该userID可能有很多条记录，若简单的按照上述方法进行拆分，则可能打爆其中一个数据库。<br>一般来说，会将一段时间以前的数据归档（比如某个userID三个月之前的数据），存放到类似HBase这种非关系型数据库中，以此来解决上述问题。</p>
<p><strong>2. 分库分表之后就要求每个查询的where子句中必须携带分库分表键，但并非每个查询都能携带分库分表键的。</strong><br>比如订单库按照订单号hash取模之后存储，此时分库分表键为订单号，那么想查询某位买家所有的订单，查询时就没有了分库分表键，就会出现“全表扫描”的情况。<br>一般在实践中解决这种问题的方法是建立“异构索引表”，即采用异步机制将原表内的每次一创建或更新，都换一个维度保存一份完整的数据表或索引表，拿空间换时间。<br>在上面说到，订单库按照订单号hash取模之后存储，同时也按照userID维度进行hash取模，再存储一份数据，那么想要获取某一userID的全部订单时，就将userID作为分库分表键传进去即可，避免了全表扫描。</p>
<h3 id="第三方中间件"><a href="#第三方中间件" class="headerlink" title="第三方中间件"></a>第三方中间件</h3><p>分库分表虽好，但是带来的一系列问题也是需要解决的。比如对开发人员要求增加、工作量的增加、同时bug量也会增加。那么这些问题肯定会有中间件来帮我解决的。这里只列举社区中比较有知名度的几个：</p>
<ol>
<li>阿里的 TDDL、DRDS和cobar</li>
<li>开源社区的sharding-sphere</li>
<li>民间的mycat</li>
</ol>
<p>以及还有，360的Atlas、美团的zebra。具体中间件怎么使用，大家可以各自去了解。这么多的分库分表中间件全部可以归结为两大类型：</p>
<ol>
<li>CLIENT模式</li>
<li>PROXY模式</li>
</ol>
<p>CLIENT模式代表有阿里的TDDL，开源社区的sharding-jdbc（sharding-jdbc的3.x版本即sharding-sphere已经支持了proxy模式）。PROXY模式代表有阿里的cobar，民间组织的MyCAT。无论是CLIENT模式，还是PROXY模式。几个核心的步骤是一样的：<strong>SQL解析，重写，路由，执行，结果归并</strong>。</p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=https://github.com/farawayliu&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>far</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/04/21/java/谈谈分表分库常见问题解决方案/">https://www.ofcoder.com/2019/04/21/java/%E8%B0%88%E8%B0%88%E5%88%86%E8%A1%A8%E5%88%86%E5%BA%93%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 2021 ofcoder. Author by far.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.ofcoder.com/2019/04/21/java/%E8%B0%88%E8%B0%88%E5%88%86%E8%A1%A8%E5%88%86%E5%BA%93%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" data-id="ckxoviwxe001cycj1ajg300qb" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAT4AAAE+CAAAAAAxUyPsAAAFNElEQVR42u3cUW7jOBAEUN//0rMHyMau6lKCAebpy4hsiXo04GI3kdcrPv58Ob6ezf/y55vj69nlmu29vl7/sQMfPnz48OF7S5MPIrl98tjvP5W8bifpO4HcBB8+fPjw4Vv48gd4f+P8bBtBbtHqO+L3USn/KuDDhw8fPny/w5cEnTyIJNffCd6/Bx8+fPjw4fub+drQkIeDJNzkZ/NpwIcPHz58+H6Trw0iSWngVgRvW/I/EY9+pNeBDx8+fPjwnULDv/D64QMfPnz48OELfp5vi+2kWL+U6Z8quyft+Q8a+PDhw4cP30kj30B2G27SMl8yVz6R7Tij4gg+fPjw4cMXO+RF859oVC9t8vzh2zZDEmVeyWl8+PDhw4fvbULIw0RCvLSoW7i2BJA/RTFafPjw4cOHLx7tcstbxMlZn5qkvG3Qlh7w4cOHDx++nC8naJf9t/b2rUzfFhryaXvdLo0PHz58+PDFDebbT/htO1pb+s9H0gasIys+fPjw4cN3+kXOm8H5Zq88stQVjhPo/iwfKi748OHDhw9f8P729kv7fAkKbeDIG95LgMOHDx8+fPhufMkHnlpmL8X6fcHfwn34WuDDhw8fPnyXevX0rzPb8vpydinW51Emb/Djw4cPHz58C9+yvWwJQG0BPae5NQM+NMW/63Xgw4cPHz58JV9C9hPN7FuYWEa1fAmKkgE+fPjw4cP3eV1cD+t2sxtKW3RoN9IlYevDdfDhw4cPH763fD/dCM+L6bdl/K1B3rbSPzTI8eHDhw8fvhPfs2X6PEDcmvTt5rY89BTTjA8fPnz48F0SwmsJE22pvW1y54WANiQlcFHTHR8+fPjw4Zv58h/+dqBJHFnunseR/I4fng4fPnz48OEr+ZbwsYeJp7r9O1y+RSCqQODDhw8fPnzfjDn5wP56KQfs42zDVrFpAB8+fPjw4Yv5bgX3Nqw8W+hPjiRXJEwfggs+fPjw4cM3lAzyN7XL/ha9bY0vG+Nezx748OHDhw9fSbZHgb0pvmwva9vbDwQXfPjw4cOH76E2+bOF+7xM0EacWwTJS/bR9OPDhw8fPnwxXxtQbi3w27az9pGW+HKbPHz48OHDh2/ny/+Sl+nbbWdta3xv5B9LHvjw4cOHD1/M1y74n4ost0HfAtCxgpJ8LfDhw4cPH76B79aKvgWXfGLaxkBbpr+1BP4nuODDhw8fPnwx31IKT4ifikR5SMqnbWkY4MOHDx8+fKeneOCHf3n/77fn8+mMvjr48OHDhw9fzHcrcO9h5VUeyxj2IFVXXPDhw4cPH77gKfag8P7Gt3Z7e7UEt40yUekEHz58+PDhi/nyZXNbMmgb0u3ms7bpvo8THz58+PDhW/iWTWNLmXtviifBJb9vO2348OHDhw/fje+2wSshuAWXfdmfj2q5Dj58+PDhw7fztSXv/O/LcOvoMJQVpinHhw8fPnz4grNPtbRvpfBbieE2kc9OMz58+PDhw7fwLSj5sJ4qHLRjyMsH+R3x4cOHDx++p/jaMLFHgRx9KWe0ASuCxocPHz58+Eq+2w/2bWGfbwVLXi+N/Pz97cTjw4cPHz58ybPnrevbbLQt7fZR2yLFElzq9IcPHz58+PDFW9NuAeLW/F6K5m1TfykB4MOHDx8+fH8DX1uaz6+Wx4j8OnnDPgpn+PDhw4cP3w/zLdHhVlZoi/v5dN5iFj58+PDhw7fz3Zbf7dCTtnr+SDl0XvSvQxI+fPjw4cN3WV8XRep8Eb63pZfYdGsz5MEIHz58+PDhK/n+A/QCNWTy6lekAAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/%E5%B9%B2%E8%B4%A7/">干货</a><a href="/tags/mysql/">mysql</a><a href="/tags/%E5%88%86%E8%A1%A8%E5%88%86%E5%BA%93/">分表分库</a></div><div class="post-nav"><a class="pre" href="/2019/05/11/middleware/redis%E5%A6%99%E7%94%A8-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/">redis妙用-应用场景</a><a class="next" href="/2019/04/09/java/%E8%B0%88%E8%B0%88mybatis%E3%80%81dubbo%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/">谈谈mybatis、dubbo基础原理</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'s8pJruGkXvi5Skd0e6EaMQ5X-gzGzoHsz',
  appKey:'K3NjnXxqhPNwUw5pmqOzoO4i',
  placeholder:'说出你的故事...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#分表分库案例"><span class="toc-number">1.</span> <span class="toc-text">分表分库案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用解决方案"><span class="toc-number">2.</span> <span class="toc-text">常用解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分表"><span class="toc-number">2.1.</span> <span class="toc-text">分表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分库"><span class="toc-number">2.2.</span> <span class="toc-text">分库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分表分库"><span class="toc-number">2.3.</span> <span class="toc-text">分表分库</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#副作用解决方案"><span class="toc-number">3.</span> <span class="toc-text">副作用解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三方中间件"><span class="toc-number">4.</span> <span class="toc-text">第三方中间件</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">并发笔记 - ofcoder.com | </a><a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">粤ICP备18053760号</a><div>本站访客 <span id="busuanzi_value_site_uv"></span>人次 | 总访问 <span id="busuanzi_value_site_pv"></span>次<img src="https://s04.flagcounter.com/count/MnzJ/bg_FFFFFF/txt_000000/border_726EE0/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" style="display: none;"/></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.7" zIndex="-1" count="5" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>