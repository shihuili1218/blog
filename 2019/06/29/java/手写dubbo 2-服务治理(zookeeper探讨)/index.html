<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>手写dubbo 2-服务治理(zookeeper探讨) | 并发笔记 - ofcoder.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><!-- 顶部加载进度条 --><script type="text/javascript" src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">手写dubbo 2-服务治理(zookeeper探讨)</h1><a id="logo" href="/.">并发笔记 - ofcoder.com</a><p class="description">一位后端开发的养肝历程，护发经验</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/book/"><i class="fa fas fa-book"> book</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">手写dubbo 2-服务治理(zookeeper探讨)</h1><div class="post-meta">Jun 29, 2019<span> | </span><span class="category"><a href="/categories/%E6%BA%90%E7%A0%81%E7%8B%82%E6%83%B3/">源码狂想</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.4k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 5</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2019/06/29/java/%E6%89%8B%E5%86%99dubbo%202-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86(zookeeper%E6%8E%A2%E8%AE%A8)/#vcomment"><span class="valine-comment-count" data-xid="/2019/06/29/java/%E6%89%8B%E5%86%99dubbo%202-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86(zookeeper%E6%8E%A2%E8%AE%A8)/"></span><span> 条评论</span></a><div class="post-content"><p>博客中代码地址：<a href="https://github.com/farliu/farpc.git" target="_blank" rel="noopener">https://github.com/farliu/farpc.git</a><br><img src="/images/java/dubbo/dubbo_implement_1_1.png" alt="dubbo架构"></p>
<p>开始进入主题，本文主要介绍的是服务的注册和发现，也就是图片中的第1，2，3步，既然要实现服务治理，那么我们需要一个统一管理服务东西，也就是注册中心。我们需要选择的注册中心是zookeeper。<br>这里多说一句，图中的2，3很明显是分两步来处理。如果只是从注册中心拿到provider而已，那为什么要分两步呢？而且我所认识的单词也有限，要是我取名的话我可能会给它取名叫做get、return。那它为什么要叫subscribe、notify呢？这里是为了多个服务的动态发现。当你有一个provider宕机的时候，zookeeper肯定不能给一个宕机的provider给你，那么这时就需要notify了，而不get。我不知道我说清楚没。这里可以等看完本章内容后，再细细思考。</p>
<h3 id="分析实现方案"><a href="#分析实现方案" class="headerlink" title="分析实现方案"></a>分析实现方案</h3><p>按照开发惯例，先确定实现方案。要实现服务注册和发现，就相当于管理服务，管理意味着存储，我们可以先确定存储服务的结构。</p>
<p>假如现在有一个服务为Dog.walk()，我们尝试使用Map来管理它，例如Map&lt;service, provider&gt;，当服务端启动时，将自己所有的服务put到这个Map中，consumer要使用某一个服务时，只需从这个Map中get就可以拿到provider对象，而这个provider对象是什么样的数据呢？我们只需要保存consumer连接provider的数据就行了，例如ip+port。事实上，dubbo保存的数据还不止这些，包括超时时间、是否异步调用等。</p>
<p>听起来好像上述完全可以解决我们的服务治理的功能。但是这只是对于单个provider来说。假如每一个服务有多个provider，那么我们需要对Map进行改变一下，例如Map&lt;service, List<provider>&gt;。consumer在获得provider的时候，拿到一个list，然后可以根据不同的负载均衡取得具体的provider。</p>
<p>这一切听起来很完美。不管我们接下来的实现方式是使用Map或者zookeeper，又或者是redis，只要是能按照以上存储结构都能实现我们需求。事实上dubbo也是这样干的。</p>
<h3 id="zookeeper介绍"><a href="#zookeeper介绍" class="headerlink" title="zookeeper介绍"></a>zookeeper介绍</h3><p>这里简单说一下zookeeper的三个特性，因为我们都要用到。三个特性包含：存储结构、临时节点，监听器，也正因为这三个特性，zookeeper才多了许多玩法。比如可以用来做：统一配置管理、统一命名服务、分布式锁、集群管理。</p>
<h4 id="存储结构"><a href="#存储结构" class="headerlink" title="存储结构"></a>存储结构</h4><p>zookeeper的存储结构，zookeeper中管理的是一个类似文件目录的树。它是一层一层目录结构，每一个文件夹都是一个znode，如下</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">1</span>] ls /</span><br><span class="line">[zookeeper, faregistrys]</span><br><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">2</span>] ls /faregistrys</span><br><span class="line">[com<span class="selector-class">.ofcoder</span><span class="selector-class">.farpc</span><span class="selector-class">.demo</span><span class="selector-class">.api</span>.IWelcome]</span><br><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">3</span>] ls /faregistrys/com<span class="selector-class">.ofcoder</span><span class="selector-class">.farpc</span><span class="selector-class">.demo</span><span class="selector-class">.api</span>.IWelcome</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<p>zookeeper的根节点路径为/，ls是列出该路径下的所有的节点。上述zookeeper存储的结构用图表示可能更能理解，如下<br><img src="/images/java/dubbo/dubbo_implement_2_2.png" alt="zk存储结构"><br>这也是为什么zookeeper可以做为分布式锁的原因，因为目录路径只会存在唯一。每一次新建一个节点就相当于获得锁。这个后续会在另外的文章中讲述。</p>
<h4 id="临时节点"><a href="#临时节点" class="headerlink" title="临时节点"></a>临时节点</h4><p>其中zookeeper，它区分为临时节点（EPHEMERAL）和永久节点（PERSISTENT）。dubbo使用它来管理provider。</p>
<ul>
<li>短暂/临时(Ephemeral)：当客户端和服务端断开连接后，所创建的Znode(节点)会自动删除</li>
<li>临时顺序编号目录节点(EPHEMERAL_SEQUENTIAL)：客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号</li>
<li>持久(Persistent)：当客户端和服务端断开连接后，所创建的Znode(节点)不会删除</li>
<li>持久化顺序编号目录节点(PERSISTENT_SEQUENTIAL)：客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号</li>
</ul>
<h4 id="监听机制"><a href="#监听机制" class="headerlink" title="监听机制"></a>监听机制</h4><p>我们已经简单知道了zoKeeper的数据结构了，zooKeeper还配合了监听器才能够做那么多事的。客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、被删除、子目录节点增加删除）时，zookeeper会通知客户端。例如：集群管理。</p>
<p>集群管理无非在乎两点：机器的加入和退出。所有机器约定在父目录下创建临时目录节点，然后监听父目录节点的子节点变化消息。一旦有机器挂掉，该机器与 zookeeper的连接断开，其所创建的临时目录节点被删除，所有其他机器都会收到通知：某个兄弟目录被删除。对于机器加入也是一样。</p>
<h3 id="dubbo如何使用zookeeper作为注册中心"><a href="#dubbo如何使用zookeeper作为注册中心" class="headerlink" title="dubbo如何使用zookeeper作为注册中心"></a>dubbo如何使用zookeeper作为注册中心</h3><p>了解了zookeeper的特性，我们现在就可以确定如何用它来完成注册中心的功能，这里我们借鉴dubbo。</p>
<p>dubbo在使用zookeeper作为注册中心时。它将<strong>每一个服务作为一个节点，服务的provider作为该节点的子节点</strong>。这个结构相当于之前所说的Map&lt;service, List<provider>&gt;。其provider的节点为临时节点。当provider宕机或者断开zookeeper连接时，该节点也将销毁。</p>
<p>dubbo的consumer，使用zookeeper的监听机制，监听所有服务的节点，当某一个服务下的子节点也更新或者删除时，dubbo的consumer能及时收到信息，并更新provider列表。</p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=https://github.com/farawayliu&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>far</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/06/29/java/手写dubbo 2-服务治理(zookeeper探讨)/">https://www.ofcoder.com/2019/06/29/java/%E6%89%8B%E5%86%99dubbo%202-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86(zookeeper%E6%8E%A2%E8%AE%A8)/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 并发笔记 - ofcoder.com. Author by far.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.ofcoder.com/2019/06/29/java/%E6%89%8B%E5%86%99dubbo%202-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86(zookeeper%E6%8E%A2%E8%AE%A8)/" data-id="cl7wxhx6j0010lcj19t636xty" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASYAAAEmCAAAAADqr2IGAAAEj0lEQVR42u3a206sQBAF0PP/P+15NmZw7yommcbFk0EEemHSdfv3Lz6+fhw/f/vz51dnrv/2+sjf6uc1yfusDkyYMGHC9JFMyWtdn59h5dzXQO3i8w+DCRMmTJiexJTc7tUrbij34UUbKCS4mDBhwoQJU5J2Xm/es8UkgUuy/WPChAkTJkx58pmkne31+Ru2STsmTJgwYfqbTPnt8k13VrTdNCZz0DfWwjFhwoQJ04cxzVqAz/j5LfNNmDBhwoTpY5i+yiNvSb5jMGi2rtlKv90BEyZMmDAdy5S/yqY8WhRSR0XehCb/qC+vxIQJEyZMxzIlhdfkMdcjOPv7bD5bMiRUVMQxYcKECdMhTPnmnT+4fa1NszPnXiXzmDBhwoTpWKak7ZdszHlIsekP5uHLvXfGhAkTJkynM7WjLe3i701r22bnJmTBhAkTJkynM92VFuatxP2mnu/Uear8y9oxYcKECdMjmNoHt6XePNRoy7VtGp+/bRTFYMKECROmA5lmzcW7ltQuOP8wbVCCCRMmTJiexDRLEZOQoq06bxLvtqwcCWDChAkTpmOZZqOobad0tknnd8vvk5ewIyBMmDBhwnQI0z41nTUp2ynQ/IlvGQbChAkTJkwHMm3ah/kCki15ts3nYUp7JSZMmDBhegbTphE4K5jOtuR8tGgWZERVAUyYMGHCdCxTu5jrxyQp9GY7348QtZSYMGHChOl0prrPuQ4FNkHGPghIri9q4ZgwYcKE6YOZ8gGavBycp5r7++RBRvvxvp3HhAkTJkyPYNoPzbSvu99zZ+9fN2IxYcKECdOxTO2ITDv0c32mTZ43uLNEHRMmTJgwnc40K7zOSrR3DQPlJem2bF3/B2HChAkTpo9nmjUj8yGYfIhnVlzOW57tb1+WejFhwoQJ04FMsyGYfKRmmIuXafZd6XE05YQJEyZMmA5napPMZGHtktoUejamUyfYmDBhwoTpKKZ2S54d+xChHSGatVGLSjMmTJgwYTqWab+5boZ49gM9LWj0REyYMGHCdDjTbKhls/232fk7NvsisceECRMmTMcy5QSbRmO+VW/KzRumqBaOCRMmTJgOZ8oXMGtw3jUG1N45ef8ofMGECRMmTAcytaXS2ZV5qbdtrCZJ+Gy452UtHBMmTJgwHcWUb/N5K/GuV5wFEHk7s26FYsKECROmA5na4Zv9yE4eWLTjPrPGavS3mDBhwoTpEUz5lrwHza9pUTYJfNHIxIQJEyZMBzK1y2gbnMO8/KYhoTadrh+MCRMmTJg+kikHihp+ZauyHcfJjzaUqa/HhAkTJkyHMM0e327b+ZnNs9pwoSglY8KECROmY5nabXKTBudJb17enSXwbZKMCRMmTJhOZ5oFAXVhdJFy5w3XfJuvU2VMmDBhwnQ4Uzv4kj9mH5skpeS7Gq6/lHoxYcKECdOfYZoFFrNSb5uyzorUqyknTJgwYcL0OKa2SbkJLNpSb/5hig+MCRMmTJgOZ0o20fYxm3bjrOmYBBl5MDGshWPChAkTpg9jasuss/Lupj2ZfM48rGnvgAkTJkyYjmX6D2cgjK0mDyC+AAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/%E5%B9%B2%E8%B4%A7/">干货</a><a href="/tags/dubbo/">dubbo</a><a href="/tags/%E6%BA%90%E7%A0%81/">源码</a><a href="/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/">服务治理</a><a href="/tags/zookeeper/">zookeeper</a></div><div class="post-nav"><a class="pre" href="/2019/07/02/java/%E6%89%8B%E5%86%99dubbo%203-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86(%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C-zookeeper)/">手写dubbo 3-服务治理(服务注册-zookeeper)</a><a class="next" href="/2019/06/26/java/%E6%89%8B%E5%86%99dubbo%201-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">手写dubbo 1-基本原理</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'s8pJruGkXvi5Skd0e6EaMQ5X-gzGzoHsz',
  appKey:'K3NjnXxqhPNwUw5pmqOzoO4i',
  placeholder:'说出你的故事...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#分析实现方案"><span class="toc-number">1.</span> <span class="toc-text">分析实现方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zookeeper介绍"><span class="toc-number">2.</span> <span class="toc-text">zookeeper介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#存储结构"><span class="toc-number">2.1.</span> <span class="toc-text">存储结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#临时节点"><span class="toc-number">2.2.</span> <span class="toc-text">临时节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#监听机制"><span class="toc-number">2.3.</span> <span class="toc-text">监听机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dubbo如何使用zookeeper作为注册中心"><span class="toc-number">3.</span> <span class="toc-text">dubbo如何使用zookeeper作为注册中心</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">并发笔记 - ofcoder.com | </a><a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">粤ICP备18053760号</a><div>本站访客 <span id="busuanzi_value_site_uv"></span>人次 | 总访问 <span id="busuanzi_value_site_pv"></span>次<img src="https://s04.flagcounter.com/count/MnzJ/bg_FFFFFF/txt_000000/border_726EE0/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" style="display: none;"/></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>