<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>手写dubbo 1-基本原理 | 并发笔记 - ofcoder.com</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><!-- 顶部加载进度条 --><script type="text/javascript" src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">手写dubbo 1-基本原理</h1><a id="logo" href="/.">并发笔记 - ofcoder.com</a><p class="description">一位后端开发的养肝历程，护发经验</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/usql/"><i class="fa fa-database"> usql</i></a><a href="/book/"><i class="fa fas fa-book"> book</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">手写dubbo 1-基本原理</h1><div class="post-meta">Jun 26, 2019<span> | </span><span class="category"><a href="/categories/%E6%BA%90%E7%A0%81%E7%8B%82%E6%83%B3/">源码狂想</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.8k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 6</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2019/06/26/java/%E6%89%8B%E5%86%99dubbo%201-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/#vcomment"><span class="valine-comment-count" data-xid="/2019/06/26/java/%E6%89%8B%E5%86%99dubbo%201-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/"></span><span> 条评论</span></a><div class="post-content"><p>本系列，原本由之前挖的坑，现在来填。之间在讲述动态代理，谈及mybatis、dubbo的源码，大家也可以前往了解，<a href="https://www.ofcoder.com/2019/04/09/java/%E8%B0%88%E8%B0%88mybatis%E3%80%81dubbo%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/">点击查看</a>。手写dubbo，是为了更好的理解dubbo源码原理，顺便和大家一起看看dubbo实现过程。</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>本系列博客，主要实现dubbo的服务调用，基于<strong>netty/http+zookeeper/redis</strong>。所以你有必要准备zookeeper和redis的环境。这个自行百度，这里讲述毫无意义。<br>毕竟是剖析dubbo源码，建议大家还是有必要将源码下载下来阅读一下，以及本博客中所有代码，可以通过下面链接下载。</p>
<ul>
<li>博客中代码<br><a href="https://github.com/farliu/farpc.git" target="_blank" rel="noopener">https://github.com/farliu/farpc.git</a></li>
<li>dubbo源码<br><a href="https://github.com/apache/dubbo.git" target="_blank" rel="noopener">https://github.com/apache/dubbo.git</a></li>
</ul>
<h3 id="dubbo介绍"><a href="#dubbo介绍" class="headerlink" title="dubbo介绍"></a>dubbo介绍</h3><p>Apache Dubbo |ˈdʌbəʊ| is a high-performance, light weight, java based RPC framework. Dubbo offers three key functionalities, which include <strong>interface based remote call, fault tolerance &amp; load balancing, and automatic service registration &amp; discovery</strong>.</p>
<p>这段介绍来自dubbo官网，打开官网就能看到，我认识的单词也不多，就把认识的标粗了。它告诉我们dubbo实现了三个功能</p>
<ol>
<li>远程接口调用</li>
<li>容错和负载均衡</li>
<li>服务自动注册和发现</li>
</ol>
<p>那么我们手写dubbo的话，自然也要实现官网中介绍的三个功能，也就是本系列博客的重点。与之对应的，官网还提供了一张图，描述了这个三功能如何配合使用的。如下</p>
<p><img src="/images/java/dubbo/dubbo_implement_1_1.png" alt="dubbo架构"></p>
<p>简单看一下这张图，provider在registry中注册自己的服务，consumer从register中subscribe服务。consumer拿到服务后，直接invoke对应的provider。其中dubbo还提供监控的功能，也就是monitor。那么我们接下来顺着这张图揣测一下dubbo三个功能的原理</p>
<h3 id="揣测dubbo原理"><a href="#揣测dubbo原理" class="headerlink" title="揣测dubbo原理"></a>揣测dubbo原理</h3><p>先回顾一下dubbo的诞生的场景。dubbo作为一款分布式服务治理框架，这是没有异议的。它帮助我们完成了应用之间的调用。那么在没有它之前我们想在两个系统之间调用对方的服务是怎么做的呢？</p>
<p>从单体应用系统开始说，我们现在有两个类Person、Dog，假如我们需要Person的对象调用Dog中walk()方法。那么我们的做法肯定都是new Dog().walk();。这个已经是习以为常的了，没什么好说的，但是我们为什么能new一个Dog对象，因为在我们系统中存在Dog的class文件，我们才能new。那么假如这两个类存在于两个系统中，它们需要互相调用，我们是怎么做的呢？存在以下两种解决方案</p>
<ol>
<li>A(provider)应用提供jar供B(consumer)应用调用，此时A应用的class文件会加载到B系统中，B可以直接new出A的对象。</li>
<li>通过网络调用，B(consumer)应用通过网络告诉A(provider)要调用那个方法，A调用完后将结果返回给B。</li>
</ol>
<p>第一种方案，没什么好说的。而dubbo也就是第二中方案的实现框架。那么一起来猜测一下dubbo怎么做到调用本方法那样去调用远程服务的。</p>
<h4 id="远程接口调用"><a href="#远程接口调用" class="headerlink" title="远程接口调用"></a>远程接口调用</h4><p>作为一款rpc框架，主要任务就是远程调用，那么我们从这里入手肯定是没错的。现在需求是A系统提供一个服务供B系统调用。那我们先确认两个概念，A也就是provider，B为consumer，那么一个个的来分析。</p>
<p>作为provider需要给别人提供服务，肯定是要给别人调用的。比如我们写的restful接口，别人使用http来调用我们的接口，那么作为provider我们也需要这样的程序。这里我们可以选择tomcat提供http协议的服务，也可以通过socket供客户端来连接。不管怎么样，这两种实现方式肯定是可以供consumer调用的。</p>
<p>provider提供调用的服务，我们可以解决了，那么客户端调用过来时候，provider怎么知道要执行哪个方法呢？这是你可能会想这个可以由consumer在调用时传几个参数告诉provider。对的。事实上dubbo也确实是这样做的，它会传输类似以下对象的数据给provider</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">String</span> clazz;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">String</span> method;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">String</span> types;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">String</span> params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时，怎么调用解决了，要调用哪个服务也解决了，那么这时由provider通过反射执行对应方法。至此，我觉得provider的实现方式，这个方案是可行的。<br>接下来看consumer，consumer要做的事情就是调用provider的服务，如果provider提供的是http接口，那么我就通过httpClient来调用；如果provider提供的socket，那么就用socket来连接，这都是可以实现的。但是会存在一个问题，就是我们在调用是写HttpClient代码调用时，对不起，哥们，我觉得我是在调用服务端代码，这不是我想要的。而这时dubbo提供的解决方案就是动态代理，consumer像调用本地方法那样去调用某一个服务，由代理类去完成远程调用的过程。</p>
<p><strong>小小的总结一下，dubbo远程调用，由consumer在代理类中通过http/socket去调用provider提供的服务。</strong></p>
<h4 id="服务自动注册和发现"><a href="#服务自动注册和发现" class="headerlink" title="服务自动注册和发现"></a>服务自动注册和发现</h4><p>服务自动注册和发现，也就是图中registry。consumer需要去远程调用provider，那么肯定是要有一个ip和端口号的，要不然你怎么调用。当provider提供的服务比较多，或者同一个服务有多个provider时，它们都分别有自己的ip和端口号，那么consumer怎么去维护呢？这时注册中就显得尤为重要。</p>
<p>那么dubbo的注册和发现是怎么做的呢？其实要完成上面的需要，我们是不是只要有一个统一管理的地方就行了，对不对。最不济我弄一个Map<service, provider>，这样把它存下来就好了，provider启动时往这个map里put服务当作服务注册的过程，consumer要使用时，到这个map中取就好了。</p>
<p>上面的方案是可以实现的，但是dubbo提供的解决方案是zookeeper/redis，但是它们中间存储的数据结构类似Map中的数据，只是存储数据的载体不是Map而已，这个我们在写代码中会得以体现。</p>
<h4 id="容错和负载均衡"><a href="#容错和负载均衡" class="headerlink" title="容错和负载均衡"></a>容错和负载均衡</h4><p>博客中实现的负载均衡，只是从众多的provider中简单的random一个出来，其余的负载均衡选择算法，可以参照dubbo源码实现。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>根据我们上面的推理，dubbo原理总结为：provider提供服务，这个服务可以是<strong>http/socket</strong>，给consumer来调用，然后通过<strong>反射</strong>的方式执行对应的方法，将结果返回给consumer。为了让这个过程无感知，consumer使用<strong>动态代理</strong>的过程，完成调用过程。</p>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><ol>
<li>手写dubbo框架1-基本原理</li>
<li>手写dubbo框架2-服务治理和发现<br>2.1 分布式锁（redis+zookeeper）</li>
<li>手写dubbo框架3-spi治理redis和zk<br>3.1 spi详解</li>
<li>手写dubbo框架4-远程调用\动态代理（netty+http）</li>
</ol>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=https://github.com/farawayliu&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>far</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/06/26/java/手写dubbo 1-基本原理/">https://www.ofcoder.com/2019/06/26/java/%E6%89%8B%E5%86%99dubbo%201-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 2021 ofcoder. Author by far.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.ofcoder.com/2019/06/26/java/%E6%89%8B%E5%86%99dubbo%201-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/" data-id="ckxm1vibr0010f8j1ggh4afg0" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADJUlEQVR42u3aQU7DQAwF0N7/0mWLBIRveyo17psVCukkz0g1tufxiNfz2/p55fr6999e75m8w2SH8sLGxsa+Cft5ua4f8POeJFhVzPU9SdB/CQ02Njb2OvZ1wrh+TJ5UqsFNAn19/5/XsbGxsbGDz+Zpplo1YGNjY2OfYp9qUZ1taWFjY2N/JjtJOUmDKSE94zUPx4FeGjY2Nvbbs6tD1nf++SXzbWxsbOw3Zj9bq1oeJGXPJP2U3x8bGxt7EXt+sObs0Z+cV22BYWNjY+9m51skYeod2UkCUR0w54kTGxsbexM7f91qUKoJpleENEfL2NjY2DdnV5NNPjw4Vdj0xsP/BBEbGxt7ETt5lfwATT4GqBY/eYgLb46NjY29gp1/9VcfmRcGkyu9/bGxsbF3sJNhbT5GnRc2k/ZTng6xsbGxN7Grg4FJ2VBtKuVr9D7Y2NjYN2dPqNUWz6k9538YbGxs7E3sSZlx6re9wPVKGmxsbOx97FMFxry5X92h15DCxsbG3s3OM16vTZ8f7ukNjPM0jI2Njb2PXU0S8wOaeTiqxUz0btjY2NgfwE4+nDyy2q7qFR6FAzrY2NjY69jlW48OaF9X3kRXsLGxsRexe+PevBlUbetPhgf5/djY2Ng72PlRmGqJkiS/eRCrJRY2Njb2J7CrLZuzpUg0pi0WML/8jI2Njb2IXT1G0yshqlVREr4c+U/Cw8bGxr45e/IS+QGdpLmf71ANTaF/ho2NjX1b9ny82jtqkxcevVHBny5sbGzspezJoZyEkbf1e+FInv6Y52psbGzsN2PnBUmvdKkeADq1jtVh2NjY2G/PbsapeLCy2lTq7VNIftjY2NiL2JODL9U2UJ4gC+2hycLGxsZewe79i99rDPWCnjSk8h2wsbGx97F73/nXVyat/5w9GVpgY2Nj72P3ktbZIXF1ZNtLVNjY2Ni72ZOiIi8Sqs+alxbRfBsbGxv7Y9jVwzr52Lg3GMjHvaMEho2Njb2IXfhHv1jA9IYNeYJ8VLMuNjY29g3Zp5r11YC+Yoco4WFjY2MvYp9KJNXsUB0DVxMwNjY29gewvwB4cozg3z+QygAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/%E5%B9%B2%E8%B4%A7/">干货</a><a href="/tags/dubbo/">dubbo</a><a href="/tags/%E6%BA%90%E7%A0%81/">源码</a></div><div class="post-nav"><a class="pre" href="/2019/06/29/java/%E6%89%8B%E5%86%99dubbo%202-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86(zookeeper%E6%8E%A2%E8%AE%A8)/">手写dubbo 2-服务治理(zookeeper探讨)</a><a class="next" href="/2019/05/29/middleware/redis%E5%A6%99%E7%94%A8-zset%E7%B1%BB%E5%9E%8B/">redis妙用-zset类型</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'s8pJruGkXvi5Skd0e6EaMQ5X-gzGzoHsz',
  appKey:'K3NjnXxqhPNwUw5pmqOzoO4i',
  placeholder:'说出你的故事...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备"><span class="toc-number">1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dubbo介绍"><span class="toc-number">2.</span> <span class="toc-text">dubbo介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#揣测dubbo原理"><span class="toc-number">3.</span> <span class="toc-text">揣测dubbo原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#远程接口调用"><span class="toc-number">3.1.</span> <span class="toc-text">远程接口调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务自动注册和发现"><span class="toc-number">3.2.</span> <span class="toc-text">服务自动注册和发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#容错和负载均衡"><span class="toc-number">3.3.</span> <span class="toc-text">容错和负载均衡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#目录结构"><span class="toc-number">5.</span> <span class="toc-text">目录结构</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">并发笔记 - ofcoder.com | </a><a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">粤ICP备18053760号</a><div>本站访客 <span id="busuanzi_value_site_uv"></span>人次 | 总访问 <span id="busuanzi_value_site_pv"></span>次<img src="https://s04.flagcounter.com/count/MnzJ/bg_FFFFFF/txt_000000/border_726EE0/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" style="display: none;"/></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.7" zIndex="-1" count="5" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>